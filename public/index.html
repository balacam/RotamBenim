<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avrupa Gezi Listesi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .place-item:hover {
            background-color: #f0f9ff;
        }
        .place-item.selected-for-route {
            background-color: #dbeafe;
            border-left: 4px solid #2563eb;
        }
        .country-header {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e3a8a;
        }
        #generateRouteBtn, #addPlaceBtn, .delete-place-btn, #googleSignInBtn, #signOutBtn {
            transition: background-color 0.3s ease;
        }
        .category-tag {
            display: inline-block;
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-right: 0.25rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .delete-place-btn {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .delete-place-btn:hover {
            background-color: #fecaca; /* red-200 */
        }
        #userDisplay { 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
         .filter-container > div {
            margin-bottom: 0.5rem;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .filter-container {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .filter-container > div {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="container mx-auto max-w-7xl bg-white shadow-xl rounded-lg p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600">Avrupa Gezi Rotam</h1>
            <p class="text-gray-600 mt-2">Gezilecek yerleri işaretle, filtrele, sil ve haritada gör! Rota oluşturmak için yerlere tıklayarak seçin veya yeni yer ekleyin.</p>
            
            <div id="authContainer" class="mt-4">
                <button id="googleSignInBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center mx-auto">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.63 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path fill="none" d="M0 0h24v24H0z"/></svg>
                    Google ile Giriş Yap
                </button>
                <div id="userDisplay" class="hidden mt-2 justify-center">
                    <img id="userPhoto" class="w-8 h-8 rounded-full mr-2" alt="Kullanıcı Fotoğrafı">
                    <span id="userName" class="text-sm text-gray-700 font-medium"></span>
                    <button id="signOutBtn" class="ml-4 bg-red-500 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-xs shadow-md">Çıkış Yap</button>
                </div>
            </div>
            <p id="authStatus" class="text-xs text-gray-500 mt-1">Kimlik durumu: Kontrol ediliyor...</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-1"></p>
        </header>

        <div class="flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-3/5 lg:w-2/3 pr-0 md:pr-4">
                <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-slate-50">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Yeni Yer Ekle</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="newPlaceNameInput" placeholder="Örn: Etretat Kayalıkları" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                        <button id="addPlaceBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-md shadow-md flex items-center justify-center" disabled>
                            <span id="addPlaceBtnText">Yer Ekle</span>
                            <div id="addPlaceLoader" class="loader hidden"></div>
                        </button>
                    </div>
                    <div id="addPlaceMessage" class="text-sm mt-2"></div>
                </div>

                <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-700">Gezilecek Yerler</h2>
                        <p class="text-sm text-gray-500">Rota oluşturmak için listeden yerlere tıklayın.</p>
                    </div>
                     <div class="filter-container">
                        <div>
                            <label for="filterCountry" class="mr-2 text-gray-600">Ülke:</label>
                            <select id="filterCountry" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                <option value="all">Tüm Ülkeler</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterVisited" class="mr-2 text-gray-600">Ziyaret:</label>
                            <select id="filterVisited" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                <option value="all">Tümü</option>
                                <option value="notvisited" selected>Gezilmedi</option>
                                <option value="visited">Gezildi</option>
                            </select>
                        </div>
                    </div>
                </div>
                 <div class="mb-4">
                    <button id="generateRouteBtn" class="w-full sm:w-auto bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-md shadow-md disabled:opacity-50" disabled>
                        Seçilenlerle Rota Oluştur
                    </button>
                </div>
                <div id="routeLinkContainer" class="mb-4 text-sm"></div>
                <div id="placesList" class="space-y-1 max-h-[40vh] md:max-h-[50vh] overflow-y-auto custom-scrollbar pr-2">
                    <p id="placesListStatus" class="text-gray-500 italic p-4">Lütfen Google ile giriş yapın veya yer listesinin yüklenmesini bekleyin...</p>
                </div>
            </div>

            <div class="w-full md:w-2/5 lg:w-1/3 mt-6 md:mt-0">
                <h2 id="mapTitle" class="text-2xl font-semibold text-gray-700 mb-2">Harita</h2>
                <p id="mapLocationName" class="text-sm text-gray-500 mb-4 h-5"></p>
                <div class="aspect-w-16 aspect-h-9 md:aspect-h-12 lg:aspect-h-10 rounded-lg overflow-hidden shadow-md">
                     <iframe id="mapFrame"
                        class="w-full h-full border-0"
                        loading="lazy"
                        allowfullscreen
                        referrerpolicy="no-referrer-when-downgrade"
                        src="https://maps.google.com/maps?q=Avrupa&t=&z=4&ie=UTF8&iwloc=&output=embed">
                    </iframe>
                </div>
                <p class="mt-4 text-xs text-gray-500">
                    Haritada bir yerin işaretlenmesi, o yerin genel konumunu gösterir. Rota oluşturma özelliği, seçilen yerleri Google Haritalar'a gönderir. Yeni yer ekleme özelliği, bilgileri otomatik olarak bulmaya çalışır; sonuçlar API'lerin yeteneklerine bağlıdır. Verileriniz Firebase'de saklanır.
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, updateDoc, onSnapshot, query, orderBy, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6bIJOkooeRSKWtb09zdNmMIjHDbXCzYA", 
            authDomain: "rotambenim.firebaseapp.com", 
            projectId: "rotambenim", 
            storageBucket: "rotambenim.firebasestorage.app", 
            messagingSenderId: "374285362920", 
            appId: "1:374285362920:web:b4058cf4a93e7337168b5d", 
            measurementId: "G-0QVZ4LDYPJ" 
        };
        
        const appId = firebaseConfig.appId || 'default-app-id';
        const CURRENT_INITIAL_DATA_VERSION = "1.2"; 

        let app;
        let auth;
        let db;
        let userId;
        let placesCollectionRef; 
        let unsubscribePlaces = null; 

        // Kapsamlı initialPlacesData dizisi (Bir önceki yanıttaki gibi tüm yerleri içermeli)
        const initialPlacesData = [
            // FRANSA
            { userGivenId: 'fr_001', country: "FRANSA", name: "Paris", city: "Paris", description: "Dünyanın en romantik şehirlerinden biri olan Paris, 'Işık Şehir' olarak da anılır...", category: "Başkent / İkonik / Kültürel / Sanat", visited: false, mapQuery: "Paris, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_002', country: "FRANSA", name: "Eyfel Kulesi", city: "Paris", description: "Paris'in ve Fransa'nın en tanınmış sembolü olan Eyfel Kulesi...", category: "İkonik Yapı / Mimari / Manzara", visited: false, mapQuery: "Eyfel Kulesi, Paris", selectedForRoute: false },
            // ... (BURAYA DİĞER TÜM KAPSAMLI YER LİSTENİZİ EKLEYİN) ...
            // Örnek olarak İtalya ve İspanya'dan birkaç yer daha:
            { userGivenId: 'it_001', country: "İTALYA", name: "Roma", city: "Roma", description: "Binlerce yıllık tarihiyle 'Ebedi Şehir' Roma...", category: "Başkent / Tarihi", visited: false, mapQuery: "Roma, İtalya", selectedForRoute: false },
            { userGivenId: 'es_001', country: "İSPANYA", name: "Barselona", city: "Barselona", description: "Katalonya'nın başkenti Barselona, Antoni Gaudí'nin eşsiz modernist mimarisinin damgasını vurduğu bir şehirdir...", category: "Şehir / Mimari", visited: false, mapQuery: "Barselona, İspanya", selectedForRoute: false },
        ];
        let placesData = []; 

        const placesListElement = document.getElementById('placesList');
        const filterElement = document.getElementById('filterVisited');
        const countryFilterElement = document.getElementById('filterCountry');
        const mapFrameElement = document.getElementById('mapFrame');
        const mapLocationNameElement = document.getElementById('mapLocationName');
        const generateRouteBtn = document.getElementById('generateRouteBtn');
        const routeLinkContainer = document.getElementById('routeLinkContainer');
        const newPlaceNameInput = document.getElementById('newPlaceNameInput');
        const addPlaceBtn = document.getElementById('addPlaceBtn');
        const addPlaceBtnText = document.getElementById('addPlaceBtnText');
        const addPlaceLoader = document.getElementById('addPlaceLoader');
        const addPlaceMessage = document.getElementById('addPlaceMessage');
        const placesListStatusElement = document.getElementById('placesListStatus');
        
        const authContainer = document.getElementById('authContainer');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const userDisplay = document.getElementById('userDisplay');
        const userNameElement = document.getElementById('userName');
        const userPhotoElement = document.getElementById('userPhoto'); 
        const signOutBtn = document.getElementById('signOutBtn');
        const authStatusElement = document.getElementById('authStatus');
        const userIdDisplayElement = document.getElementById('userIdDisplay');

        let selectedRouteOrder = []; 

        function populateCountryFilter() { /* Önceki gibi */ }

        async function initializeFirebase() { /* Önceki gibi, sadece onAuthStateChanged içinde checkAndUpdateInitialData'dan sonra loadAndListenPlaces çağrılacak */ }
        googleSignInBtn.addEventListener('click', async () => { /* Önceki gibi */ });
        signOutBtn.addEventListener('click', async () => { /* Önceki gibi */ });
        
        async function checkAndUpdateInitialData() {
            if (!userId || !placesCollectionRef) {
                console.log("checkAndUpdateInitialData: userId veya placesCollectionRef tanımsız.");
                return;
            }
            const dataVersionFlagDocRef = doc(db, `users/${userId}/europeTravelFlags`, "appDataVersion");
            const versionSnap = await getDoc(dataVersionFlagDocRef);
            const currentDbVersion = versionSnap.exists() ? versionSnap.data().version : null;
            console.log(`Veri versiyonu kontrolü. Kod: ${CURRENT_INITIAL_DATA_VERSION}, DB: ${currentDbVersion}`);

            if (!initialPlacesData || initialPlacesData.length === 0) {
                console.log("initialPlacesData boş. Seeding/Update atlanıyor.");
                if (!versionSnap.exists()) { 
                     await setDoc(dataVersionFlagDocRef, { version: CURRENT_INITIAL_DATA_VERSION, lastChecked: new Date().toISOString(), status: "No initial data defined in code." });
                }
                return;
            }
            
            if (currentDbVersion !== CURRENT_INITIAL_DATA_VERSION) {
                placesListStatusElement.innerHTML = `Başlangıç verileri güncelleniyor (Kod v${CURRENT_INITIAL_DATA_VERSION}, DB v${currentDbVersion || 'yok'})... <div class='loader !ml-0 !inline-block'></div>`;
                console.log(`Başlangıç verileri ${CURRENT_INITIAL_DATA_VERSION} versiyonuna güncelleniyor/ekleniyor. Toplam ${initialPlacesData.length} yer.`);
                
                let updatedOrAddedCount = 0;
                const promises = []; // Tüm batch commit promise'lerini topla

                // Batch'leri bölmek için
                const batchSize = 490; // Firestore batch limiti 500
                for (let i = 0; i < initialPlacesData.length; i += batchSize) {
                    const batch = writeBatch(db);
                    const chunk = initialPlacesData.slice(i, i + batchSize);
                    console.log(`Batch ${Math.floor(i/batchSize) + 1} hazırlanıyor, ${chunk.length} yer içeriyor.`);

                    for (const place of chunk) {
                        if (!place.userGivenId) {
                            console.warn("userGivenId eksik, bu yer atlanıyor:", place.name);
                            continue;
                        }
                        const placeDocRef = doc(placesCollectionRef, place.userGivenId);
                        const existingDocSnap = await getDoc(placeDocRef); // Her bir dökümanı kontrol et
                        
                        let dataToSet = { ...place, id: placeDocRef.id }; 

                        if (existingDocSnap.exists()) {
                            const existingData = existingDocSnap.data();
                            dataToSet.visited = typeof existingData.visited === 'boolean' ? existingData.visited : place.visited;
                            dataToSet.selectedForRoute = typeof existingData.selectedForRoute === 'boolean' ? existingData.selectedForRoute : place.selectedForRoute;
                        } else {
                            dataToSet.visited = place.visited; 
                            dataToSet.selectedForRoute = place.selectedForRoute; 
                        }
                        batch.set(placeDocRef, dataToSet); 
                        updatedOrAddedCount++;
                    }
                    promises.push(batch.commit().then(() => {
                        console.log(`Bir batch (${chunk.length} yer) başarıyla yazıldı.`);
                    }).catch(e => {
                        console.error("Bir batch yazma hatası:", e);
                        // Hata durumunda diğer batch'leri de etkilememek için burada promise'i reject etmeyebiliriz,
                        // ama genel bir hata olduğunu bilmeliyiz.
                        throw e; // Hatanın yukarıya yayılmasını sağla
                    }));
                }
                
                try {
                    await Promise.all(promises); // Tüm batch'lerin tamamlanmasını bekle
                    console.log(`${updatedOrAddedCount} başlangıç yeri güncellendi/eklendi.`);
                    await setDoc(dataVersionFlagDocRef, { version: CURRENT_INITIAL_DATA_VERSION, updatedAt: new Date().toISOString(), count: updatedOrAddedCount, status: `Updated to v${CURRENT_INITIAL_DATA_VERSION}` });
                    authStatusElement.textContent = `${updatedOrAddedCount} başlangıç yeri güncellendi/eklendi (v${CURRENT_INITIAL_DATA_VERSION}). Liste dinleniyor...`;
                    console.log("Data version flag güncellendi.");
                } catch (e) {
                     console.error("Başlangıç verilerini toplu güncelleme hatası:", e);
                     authStatusElement.textContent = "Başlangıç verilerini güncellemede hata. Lütfen konsolu kontrol edin.";
                }
            } else {
                authStatusElement.textContent = `Başlangıç verileri güncel (v${CURRENT_INITIAL_DATA_VERSION}). Liste dinleniyor...`;
                 console.log("Başlangıç verileri zaten güncel.");
            }
        }

        async function loadAndListenPlaces() {
            if (!placesCollectionRef) {
                console.log("placesCollectionRef tanımsız, loadAndListenPlaces atlanıyor.");
                return;
            }
            if (unsubscribePlaces) {
                console.log("Mevcut Firestore listener kaldırılıyor.");
                unsubscribePlaces(); 
                unsubscribePlaces = null;
            }
            console.log("Yeni onSnapshot listener'ı kuruluyor for", placesCollectionRef.path);
            // authStatusElement.innerHTML = "Yer listesi Firestore'dan yükleniyor... <div class='loader !ml-0 !inline-block'></div>"; // checkAndUpdateInitialData'da ayarlanıyor

            unsubscribePlaces = onSnapshot(query(placesCollectionRef, orderBy("country"), orderBy("name")), (snapshot) => {
                console.log(`onSnapshot: ${snapshot.docs.length} döküman alındı.`);
                placesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // console.log("onSnapshot - placesData güncellendi:", placesData.length > 0 ? placesData[0] : "Boş");
                populateCountryFilter(); 
                renderPlacesList();
                updateGenerateRouteButtonState();
                 if (userId) { 
                    if (placesData.length > 0) { 
                        // authStatusElement.textContent = `Yer listesi güncel (${placesData.length} yer).`; 
                    } else {
                        // authStatusElement.textContent = "Listenizde henüz yer yok veya yükleniyor...";
                    }
                }
            }, (error) => { 
                console.error("Firestore'dan yerleri dinleme hatası: ", error);
                authStatusElement.textContent = "Yer listesi yüklenemedi: " + error.message;
                 if (error.code === 'failed-precondition' && error.message.includes('indexes-not-found')) {
                    authStatusElement.innerHTML += `<br><strong class="text-red-600">Firestore İndeks Hatası!</strong> Sıralama için gerekli birleşik indeks bulunamadı. Lütfen Firebase konsolundan oluşturun.`;
                }
            });
        }

        function renderPlacesList() { /* Önceki gibi */ }
        function updateMap(place) { /* Önceki gibi */ }
        function updateGenerateRouteButtonState() { /* Önceki gibi */ }
        generateRouteBtn.addEventListener('click', () => { /* Önceki gibi */ });
        addPlaceBtn.addEventListener('click', async () => { /* Önceki gibi */ });

        filterElement.addEventListener('change', renderPlacesList); 
        countryFilterElement.addEventListener('change', renderPlacesList);
        
        initializeFirebase();

        window.addEventListener('beforeunload', () => {
            if (unsubscribePlaces) {
                unsubscribePlaces();
            }
        });

    </script>
</body>
</html>
