<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Travel List - RotamBenim</title>
    <meta name="description" content="Discover places to visit around the world, plan your routes and personalize your travel experience.">
    
    <!-- Tabler CSS -->
    <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <!-- Tabler Icons -->
    <link href="https://unpkg.com/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Styles (Tabler öncelikli olacak) -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullpage.js@4.0.20/dist/fullpage.min.css"> -->
    <!-- <link rel="stylesheet" href="styles-enhanced.css"> -->
</head>
<body>
    <!-- Navigation (Tabler Navbar) -->
    <header class="navbar navbar-expand-md navbar-dark bg-primary sticky-top">
      <div class="container-xl">
        <a href="#" class="navbar-brand">
          <span class="navbar-brand-text">RotamBenim</span>
        </a>
        <div class="navbar-nav flex-row order-md-last ms-auto" id="authContainer">
          <button id="googleSignInBtn" class="btn btn-primary d-flex align-items-center me-2">
            <i class="ti ti-brand-google me-2"></i> Sign in
          </button>
          <div id="userDisplay" class="d-none align-items-center">
            <img id="userPhoto" class="avatar avatar-sm me-2 border border-primary" alt="User Photo" loading="lazy">
            <span id="userName" class="text-white fw-medium me-3"></span>
            <button id="signOutBtn" class="btn btn-danger btn-sm">Sign Out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- FullPage Container kaldırıldı, klasik yapı başlıyor -->
    <!-- Section 1: Hero (Tabler grid) -->
    <section class="bg-primary-lt py-6">
      <div class="container-xl">
        <div class="row align-items-center min-vh-60">
          <div class="col-lg-7 mx-auto text-center">
            <h1 class="display-2 fw-bold text-primary mb-3 animate-on-scroll">My Travel List</h1>
            <p class="lead text-secondary mb-4 animate-on-scroll delay-200">Discover and organize your dream destinations around the world. Create personalized travel routes and track your adventures.</p>
            <div class="d-flex justify-content-center gap-3 animate-on-scroll delay-400">
              <a href="#add-place" class="btn btn-primary">Add Places</a>
              <a href="#places-list" class="btn btn-outline-primary">View My List</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 2: Add Place -->
    <section id="add-place" class="py-6">
      <div class="container-xl">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card card-md shadow-sm mb-4">
              <div class="card-body">
                <h2 class="h3 mb-4">Add New Places</h2>
                <!-- Tab Navigation -->
                <div class="mb-3">
                  <button id="addPlaceTab" class="btn btn-outline-dark me-2 active">Add Place</button>
                  <button id="addCountryTab" class="btn btn-outline-dark">Add Country</button>
                </div>
                <!-- Add Place Tab Content -->
                <div id="addPlaceContent">
                  <div class="d-flex flex-column flex-sm-row gap-2 mb-3">
                    <input type="text" id="newPlaceNameInput" placeholder="e.g., Eiffel Tower, Pamukkale" class="form-control" maxlength="100">
                    <button id="addPlaceBtn" class="btn btn-success" disabled>
                      <span id="addPlaceBtnText">Add Place</span>
                      <div id="addPlaceLoader" class="loader d-none ms-2"></div>
                    </button>
                  </div>
                  <div id="addPlaceMessage" class="text-sm mt-2"></div>
                </div>
                <!-- Add Country Tab Content -->
                <div id="addCountryContent" class="d-none">
                  <div class="text-center">
                    <button id="openCountrySelectorBtn" class="btn btn-purple" disabled>
                      <i class="ti ti-world me-2"></i>
                      <span id="openCountrySelectorBtnText">Select Countries to Add</span>
                    </button>
                  </div>
                  <div id="addCountryMessage" class="text-sm mt-3 text-center"></div>
                  <p class="text-sm text-secondary mt-3 text-center">Select countries to automatically add popular tourist destinations.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 3: Places List -->
    <section id="places-list" class="py-6">
      <div class="container-xl">
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card card-md shadow-sm mb-4">
              <div class="card-body">
                <h2 class="h3 mb-4">Places to Visit</h2>
                <!-- Filters -->
                <div class="row mb-3">
                  <div class="col-md-6 mb-2 mb-md-0">
                    <label for="filterCountry" class="form-label">Country:</label>
                    <select id="filterCountry" class="form-select">
                      <option value="all">All Countries</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="filterVisited" class="form-label">Status:</label>
                    <select id="filterVisited" class="form-select">
                      <option value="all">All</option>
                      <option value="notvisited" selected>Not Visited</option>
                      <option value="visited">Visited</option>
                    </select>
                  </div>
                </div>
                <!-- Route Generation -->
                <div class="mb-3 d-flex gap-2">
                  <button id="generateRouteBtn" class="btn btn-primary" disabled>
                    Create Route with Selected (<span id="selectedCount">0</span>)
                  </button>
                  <button id="clearSelectionBtn" class="btn btn-secondary d-none">
                    Clear Selection
                  </button>
                </div>
                <div id="routeLinkContainer" class="mb-3 text-sm"></div>
                <!-- Places List -->
                <div id="placesList" class="row g-2">
                  <p id="placesListStatus" class="text-secondary fst-italic p-4 text-center">
                    Please sign in with Google or wait for the places list to load...
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 4: Map View -->
    <section id="map-view" class="py-6">
      <div class="container-xl">
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card card-md shadow-sm mb-4">
              <div class="card-body">
                <h2 class="h3 mb-4">Interactive Map</h2>
                <p id="mapLocationName" class="text-primary mb-3 h-6"></p>
                <div class="ratio ratio-16x9 mb-3">
                  <iframe id="mapFrame" class="w-100 h-100 border-0" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade" src="https://maps.google.com/maps?output=embed&q=World" title="Map view"></iframe>
                </div>
                <p class="text-sm text-secondary mt-3">
                  Marking a place on the map shows its general location. The route creation feature sends selected places to Google Maps.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 5: About -->
    <section id="about" class="py-6">
      <div class="container-xl">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card card-md shadow-sm mb-4">
              <div class="card-body">
                <h2 class="h3 mb-4">About RotamBenim</h2>
                <div class="mb-4">RotamBenim helps you organize your travel plans and discover new destinations around the world.</div>
                <div class="mb-4">Create personalized travel routes, track places you've visited, and find new adventures.</div>
                <div class="mb-4">Your data is stored securely in Firebase and is accessible from any device.</div>
                <div class="d-flex gap-3">
                  <a href="#" class="text-primary"><i class="ti ti-brand-github icon-lg"></i></a>
                  <a href="#" class="text-primary"><i class="ti ti-brand-twitter icon-lg"></i></a>
                  <a href="#" class="text-primary"><i class="ti ti-brand-instagram icon-lg"></i></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Country Selector Modal -->
    <div id="countrySelectorModal" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="countrySelectorTitle" class="modal-title">Select Countries to Add</h3>
            <button id="closeCountrySelectorBtn" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row" id="countryGrid">
              <!-- Countries will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-4">
            <div class="loader"></div>
            <span class="text-gray-700">Loading...</span>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-40 space-y-2"></div>

    <!-- Scripts -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/fullpage.js@4.0.20/dist/fullpage.min.js"></script> -->
    <!-- <script src="js/enhanced-fullpage-manager.js"></script> -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/language-manager.js"></script>
    <script src="js/firebase-service.js"></script>
    <script src="js/ui-components.js"></script>
    <script src="js/place-suggestions.js"></script>
    <script src="js/place-manager.js"></script>
    <script src="js/route-manager.js"></script>
    <script src="js/place-card.js"></script>
    <script src="js/enhanced-background-manager.js"></script>
    <script src="js/auth-adapter.js"></script>
    <script src="js/app-enhanced.js"></script>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, updateDoc, onSnapshot, query, orderBy, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- START: Firebase Configuration ---
        // TODO: KENDİ FIREBASE PROJE AYARLARINIZI BURAYA GİRİN!
        // Bu değerleri Firebase konsolundan (Proje Ayarları > Genel) alın.
        const firebaseConfigFromUser = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

         const firebaseConfig = {
            apiKey: "AIzaSyB6bIJOkooeRSKWtb09zdNmMIjHDbXCzYA", 
            authDomain: "rotambenim.firebaseapp.com", 
            projectId: "rotambenim", 
            storageBucket: "rotambenim.firebasestorage.app", 
            messagingSenderId: "374285362920", 
            appId: "1:374285362920:web:b4058cf4a93e7337168b5d", 
            measurementId: "G-0QVZ4LDYPJ" 
        };
        // --- END: Firebase Configuration ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId || 'default-app-id';
        const CURRENT_INITIAL_DATA_VERSION = "1.5"; // Veri versiyonunu güncelleyelim

        // Firebase App instances
        let app;
        let auth;
        let db;
        let currentUserId = null; // userId yerine currentUserId kullanalım, daha açıklayıcı
        let placesCollectionRef;
        let unsubscribePlaces = null;

        // Initial data (örnek olarak boş bırakıldı, kendi verilerinizi ekleyebilirsiniz)
       const initialPlacesData = [
           

            // HOLLANDA (Açıklamalar Detaylandırıldı)
            { userGivenId: 'nl_001', country: "HOLLANDA", name: "Amsterdam Kanalları", city: "Amsterdam", description: "UNESCO Dünya Mirası listesindeki Amsterdam'ın tarihi kanal kuşağı (Grachtengordel), şehrin Altın Çağı'ndan kalma zarif kanal evleri, sayısız köprüsü ve pitoresk su yollarıyla ünlüdür. Tekne turu yapmak, kanallar boyunca bisiklete binmek veya sadece kıyısında oturup atmosferin tadını çıkarmak eşsiz bir deneyimdir. Anne Frank Evi, Rijksmuseum ve Van Gogh Müzesi gibi önemli yerler de bu kanallara yakındır.", category: "Şehir Simgesi / Kültürel / UNESCO / Tarihi", visited: false, mapQuery: "Amsterdam Kanalları", selectedForRoute: false },
            { userGivenId: 'nl_002', country: "HOLLANDA", name: "Keukenhof Bahçeleri", city: "Lisse", description: "Dünyanın en büyük çiçek bahçelerinden biri olan Keukenhof, özellikle ilkbahar aylarında (Mart-Mayıs arası) milyonlarca lale, nergis, sümbül ve diğer soğanlı çiçeklerin rengarenk bir şölen sunduğu bir cennettir. Her yıl farklı bir temayla düzenlenen bahçe, fotoğrafçılar ve doğa severler için kaçırılmaması gereken bir yerdir. 'Avrupa'nın Bahçesi' olarak da bilinir.", category: "Bahçe / Doğa / Çiçek / Turistik", visited: false, mapQuery: "Keukenhof, Lisse", selectedForRoute: false },
            { userGivenId: 'nl_003', country: "HOLLANDA", name: "Zaanse Schans", city: "Zaandam", description: "Amsterdam yakınlarında yer alan Zaanse Schans, Hollanda'nın geleneksel kırsal yaşamını ve endüstriyel mirasını yansıtan bir açık hava müzesi gibidir. Tarihi yel değirmenleri, ahşap evleri, peynir ve takunya (klompen) yapım atölyeleriyle ziyaretçilere zamanda bir yolculuk sunar. Zaan Nehri kıyısındaki konumuyla da oldukça fotojeniktir.", category: "Köy / Kültürel / Tarihi / Turistik / Yel Değirmeni", visited: false, mapQuery: "Zaanse Schans", selectedForRoute: false },
            { userGivenId: 'nl_004', country: "HOLLANDA", name: "Rotterdam", city: "Rotterdam", description: "II. Dünya Savaşı'nda büyük ölçüde yıkıldıktan sonra modern mimariyle yeniden inşa edilen Rotterdam, Hollanda'nın en dinamik ve yenilikçi şehirlerinden biridir. Erasmus Köprüsü, Küp Evler (Kijk-Kubus), Markthal (Pazar Yeri) gibi cesur ve fütüristik yapılarıyla tanınır. Avrupa'nın en büyük limanlarından birine de ev sahipliği yapar.", category: "Şehir / Mimari / Modern / Liman", visited: false, mapQuery: "Rotterdam", selectedForRoute: false },
            { userGivenId: 'nl_005', country: "HOLLANDA", name: "Lahey (Den Haag)", city: "Lahey", description: "Hollanda'nın idari başkenti ve kraliyet ailesinin yaşadığı şehir olan Lahey (Den Haag), Uluslararası Adalet Divanı gibi önemli uluslararası kuruluşlara ev sahipliği yapar. Binnenhof (parlamento binası), Mauritshuis (Vermeer'in 'İnci Küpeli Kız' tablosu burada) ve Barış Sarayı şehrin önemli noktalarıdır. Scheveningen sahil beldesi de yakındadır.", category: "Şehir / Kültürel / Politik / Sanat", visited: false, mapQuery: "Lahey, Hollanda", selectedForRoute: false },
            { userGivenId: 'nl_006', country: "HOLLANDA", name: "Texel", city: "Texel", description: "Wadden Denizi'ndeki en büyük ve en batıdaki Frizya adası olan Texel, geniş kumulları, uzun kumsalları, çam ormanları, pitoresk köyleri ve zengin kuş yaşamıyla Hollanda'nın önemli bir doğa ve tatil alanıdır. Ecomare fok ve kuş rehabilitasyon merkezi ile deniz feneri adanın popüler ziyaret noktalarındandır. Bisiklet sürmek ve yürüyüş yapmak için idealdir.", category: "Ada / Doğa / Plaj / Yaban Hayatı / Bisiklet", visited: false, mapQuery: "Texel, Hollanda", selectedForRoute: false },
            { userGivenId: 'nl_007', country: "HOLLANDA", name: "Hillegom (Lale Tarlaları)", city: "Hillegom", description: "Özellikle ilkbahar aylarında, Keukenhof'a yakın konumda bulunan Hillegom ve çevresindeki 'Bollenstreek' (Soğanlı Bitkiler Bölgesi), uçsuz bucaksız lale, nergis ve sümbül tarlalarının rengarenk bir halı gibi uzandığı manzaralar sunar. Bu bölgede bisikletle veya arabayla dolaşarak çiçeklerin tadını çıkarabilirsiniz.", category: "Kırsal / Doğa / Çiçek / Manzara", visited: false, mapQuery: "Hillegom, Hollanda", selectedForRoute: false },
            { userGivenId: 'nl_008', country: "HOLLANDA", name: "Utrecht", city: "Utrecht", description: "Hollanda'nın kalbinde yer alan Utrecht, tarihi merkezi, iki katlı kanalları (Oudegracht), Dom Kulesi (Hollanda'nın en yüksek kilise kulesi) ve canlı öğrenci atmosferiyle bilinir. Amsterdam'a göre daha az kalabalık ama bir o kadar çekici bir şehirdir. Rietveld Schröder Evi UNESCO Dünya Mirası'dır.", category: "Şehir / Tarihi / Kültürel / Üniversite", visited: false, mapQuery: "Utrecht, Hollanda", selectedForRoute: false },
            { userGivenId: 'nl_009', country: "HOLLANDA", name: "Giethoorn", city: "Giethoorn", description: "'Kuzeyin Venedik'i' veya 'Hollanda'nın Venedik'i' olarak da anılan Giethoorn, arabaların giremediği, ulaşımın çoğunlukla teknelerle sağlandığı kanalları, ahşap köprüleri ve kamış çatılı şirin evleriyle masalsı bir köydür. Weerribben-Wieden Milli Parkı içinde yer alır.", category: "Köy / Kanal / Eşsiz / Pitoresk", visited: false, mapQuery: "Giethoorn, Hollanda", selectedForRoute: false },
            { userGivenId: 'nl_010', country: "HOLLANDA", name: "Haarlem", city: "Haarlem", description: "Amsterdam'a yakın konumda bulunan Haarlem, tarihi merkezi, Grote Markt meydanı, St. Bavo Kilisesi, Frans Hals Müzesi ve Teylers Müzesi (Hollanda'nın en eski müzesi) ile zengin bir kültürel mirasa sahiptir. Daha sakin bir atmosfere sahip olup, 'Bloemenstad' (Çiçek Şehri) olarak da bilinir.", category: "Şehir / Kültürel / Tarihi / Müze", visited: false, mapQuery: "Haarlem, Hollanda", selectedForRoute: false },
            { userGivenId: 'nl_011', country: "HOLLANDA", name: "Leiden", city: "Leiden", description: "Hollanda'nın en eski üniversitesine (Universitas Leiden) ev sahipliği yapan Leiden, tarihi kanalları, yel değirmenleri, müzeleri (Rijksmuseum van Oudheden - Antik Çağlar Müzesi gibi) ve Rembrandt'ın doğum yeri olmasıyla bilinir. Pitoresk ve entelektüel bir atmosfere sahiptir.", category: "Şehir / Üniversite / Tarihi / Kültürel", visited: false, mapQuery: "Leiden, Hollanda", selectedForRoute: false },
            { userGivenId: 'nl_012', country: "HOLLANDA", name: "Delft", city: "Delft", description: "Ünlü mavi-beyaz Delftware seramikleriyle (Delfts Blauw) tanınan Delft, tarihi kanalları, pitoresk evleri, Nieuwe Kerk (Yeni Kilise - Hollanda kraliyet ailesinin mezarlarının bulunduğu yer) ve Oude Kerk (Eski Kilise) ile şirin ve tarihi bir şehirdir. Ressam Johannes Vermeer'in doğum yeridir.", category: "Şehir / Sanat / Seramik / Tarihi", visited: false, mapQuery: "Delft, Hollanda", selectedForRoute: false },

            // ... (Diğer tüm ülkeler ve yerler için benzer şekilde detaylı açıklamalar eklenecek)
        ];

        let placesData = [];

        // DOM Elements
        const placesListElement = document.getElementById('placesList');
        const filterElement = document.getElementById('filterVisited');
        const countryFilterElement = document.getElementById('filterCountry');
        const mapFrameElement = document.getElementById('mapFrame');
        const mapLocationNameElement = document.getElementById('mapLocationName');
        const generateRouteBtn = document.getElementById('generateRouteBtn');
        const routeLinkContainer = document.getElementById('routeLinkContainer');
        const newPlaceNameInput = document.getElementById('newPlaceNameInput');
        const addPlaceBtn = document.getElementById('addPlaceBtn');
        const addPlaceBtnText = document.getElementById('addPlaceBtnText');
        const addPlaceLoader = document.getElementById('addPlaceLoader');
        const addPlaceMessage = document.getElementById('addPlaceMessage');
        const placesListStatusElement = document.getElementById('placesListStatus');

        const authContainer = document.getElementById('authContainer');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const userDisplay = document.getElementById('userDisplay');
        const userNameElement = document.getElementById('userName');
        const userPhotoElement = document.getElementById('userPhoto');
        const signOutBtn = document.getElementById('signOutBtn');
        const authStatusElement = document.getElementById('authStatus');
        const userIdDisplayElement = document.getElementById('userIdDisplay');

        let selectedRouteOrder = []; // Rota için seçilen yerlerin ID'lerini ve sıralarını tutar

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            console.log("[initializeFirebase] Firebase başlatılıyor...");
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.error("Firebase API Key eksik veya güncellenmemiş. Lütfen firebaseConfig objesini kontrol edin.");
                    authStatusElement.textContent = "Hata: Firebase yapılandırması eksik. Lütfen API anahtarınızı kontrol edin.";
                    googleSignInBtn.disabled = true;
                    return;
                }
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("[initializeFirebase] Firebase başarıyla başlatıldı.");
                authStatusElement.textContent = "Kimlik durumu kontrol ediliyor...";

                // Handle auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        currentUserId = user.uid;
                        console.log("[onAuthStateChanged] Kullanıcı giriş yaptı:", currentUserId, user.displayName);
                        authStatusElement.textContent = `Hoşgeldin, ${user.displayName || 'Kullanıcı'}! Yerler yükleniyor...`;
                        userIdDisplayElement.textContent = `Kullanıcı ID: ${currentUserId}`;

                        userNameElement.textContent = user.displayName || 'Kullanıcı Adı Yok';
                        if (user.photoURL) {
                            userPhotoElement.src = user.photoURL;
                            userPhotoElement.classList.remove('hidden');
                        } else {
                            userPhotoElement.classList.add('hidden');
                        }
                        userDisplay.classList.remove('hidden');
                        googleSignInBtn.classList.add('hidden');
                        addPlaceBtn.disabled = false; // Kullanıcı giriş yapınca yer ekleme aktif olsun

                        // Firestore collection reference for the logged-in user
                        // Private data path:
                        placesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/places`);
                        // Public data path (eğer herkesin aynı listeyi görmesini istiyorsanız):
                        // placesCollectionRef = collection(db, `artifacts/${appId}/public/data/sharedPlaces`);

                        await checkAndUpdateInitialData(); // Kullanıcıya özel veriyi kontrol et/oluştur
                        await loadAndListenPlaces(); // Kullanıcının yerlerini yükle ve dinle

                    } else {
                        // User is signed out
                        console.log("[onAuthStateChanged] Kullanıcı çıkış yaptı veya giriş yapmamış.");
                        currentUserId = null;
                        authStatusElement.textContent = "Lütfen Google ile giriş yapın.";
                        userIdDisplayElement.textContent = "";
                        userDisplay.classList.add('hidden');
                        googleSignInBtn.classList.remove('hidden');
                        googleSignInBtn.disabled = false;
                        addPlaceBtn.disabled = true; // Kullanıcı çıkış yapınca yer ekleme pasif olsun
                        placesListElement.innerHTML = '<p class="text-gray-500 italic p-4">Yerleri görmek için lütfen giriş yapın.</p>';
                        placesData = [];
                        populateCountryFilter();
                        if (unsubscribePlaces) {
                            console.log("[onAuthStateChanged] Mevcut Firestore listener kaldırılıyor (çıkış yapıldı).");
                            unsubscribePlaces();
                            unsubscribePlaces = null;
                        }
                    }
                });

                // Attempt to sign in with custom token if available, otherwise try anonymous sign-in as a fallback if needed.
                // For this app, direct Google Sign-In is the primary method, so we don't need anonymous or custom token here initially.
                // If __initial_auth_token is provided by the environment, use it.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("[initializeFirebase] __initial_auth_token bulundu, özel token ile giriş deneniyor...");
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("[initializeFirebase] Özel token ile giriş başarılı.");
                    } catch (error) {
                        console.error("[initializeFirebase] Özel token ile giriş hatası:", error);
                        // Fallback to allowing Google Sign-In if custom token fails
                        authStatusElement.textContent = "Özel oturum açılamadı. Google ile giriş yapmayı deneyin.";
                    }
                } else {
                     console.log("[initializeFirebase] __initial_auth_token bulunamadı. Manuel Google girişi bekleniyor.");
                     // Optionally, you could sign in anonymously here if the app requires some functionality before Google sign-in
                     // await signInAnonymously(auth);
                     // console.log("[initializeFirebase] Anonim olarak giriş yapıldı (eğer etkinse).");
                }


            } catch (error) {
                console.error("[initializeFirebase] Firebase başlatma hatası:", error);
                authStatusElement.textContent = "Hata: Firebase başlatılamadı. " + error.message;
                googleSignInBtn.disabled = true;
            }
        }

        // Google Sign-In
        googleSignInBtn.addEventListener('click', async () => {
            if (!auth) {
                console.error("Auth servisi başlatılmamış.");
                authStatusElement.textContent = "Hata: Giriş servisi hazır değil.";
                return;
            }
            const provider = new GoogleAuthProvider();
            try {
                authStatusElement.textContent = "Google ile giriş yapılıyor...";
                googleSignInBtn.disabled = true;
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Google ile giriş başarılı:", user.displayName);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Google ile giriş hatası:", error);
                authStatusElement.textContent = `Giriş hatası: ${error.message}`;
                if (error.code === 'auth/popup-closed-by-user') {
                    authStatusElement.textContent = "Giriş iptal edildi. Lütfen tekrar deneyin.";
                } else if (error.code === 'auth/network-request-failed') {
                     authStatusElement.textContent = "Ağ hatası. Lütfen internet bağlantınızı kontrol edin.";
                }
                googleSignInBtn.disabled = false;
            }
        });

        // Sign Out
        signOutBtn.addEventListener('click', async () => {
            if (!auth) {
                console.error("Auth servisi başlatılmamış.");
                return;
            }
            try {
                await signOut(auth);
                console.log("Çıkış başarılı.");
                // onAuthStateChanged will handle UI updates
                selectedRouteOrder = []; // Çıkış yapınca seçili rotayı temizle
                updateGenerateRouteButtonState();
                routeLinkContainer.innerHTML = '';
                mapFrameElement.src = "https://maps.google.com/maps?output=embed&q=Avrupa"; // Haritayı sıfırla
                mapLocationNameElement.textContent = '';
            } catch (error) {
                console.error("Çıkış hatası:", error);
            }
        });

        // --- Data Management ---
        async function checkAndUpdateInitialData() {
            if (!currentUserId || !db) {
                console.warn("[checkAndUpdateInitialData] Kullanıcı ID veya DB tanımsız. Atlama.");
                return;
            }
            // Kullanıcıya özel bir "başlangıç verisi eklendi" bayrağını kontrol et
            const initialSeedFlagDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/appState`, `initialDataStatus_v${CURRENT_INITIAL_DATA_VERSION}`);
            try {
                const docSnap = await getDoc(initialSeedFlagDocRef);
                if (!docSnap.exists()) {
                    console.log(`[checkAndUpdateInitialData] Kullanıcı (${currentUserId}) için başlangıç verisi (v${CURRENT_INITIAL_DATA_VERSION}) eklenmemiş. Ekleniyor...`);
                    placesListStatusElement.textContent = "Hesabınız için başlangıç verileri hazırlanıyor...";

                    if (initialPlacesData.length > 0) {
                        const batch = writeBatch(db);
                        initialPlacesData.forEach(place => {
                            const newPlaceRef = doc(collection(db, `artifacts/${appId}/users/${currentUserId}/places`)); // Yeni doküman referansı
                            batch.set(newPlaceRef, {
                                ...place,
                                createdAt: new Date().toISOString(), // Eklenme tarihi
                                userId: currentUserId // Hangi kullanıcıya ait olduğu
                            });
                        });
                        await batch.commit();
                        console.log(`[checkAndUpdateInitialData] ${initialPlacesData.length} adet başlangıç yeri başarıyla eklendi.`);
                    } else {
                        console.log("[checkAndUpdateInitialData] Eklenecek başlangıç verisi bulunmuyor (initialPlacesData boş).");
                    }
                    await setDoc(initialSeedFlagDocRef, { seeded: true, timestamp: new Date().toISOString() });
                    console.log(`[checkAndUpdateInitialData] Başlangıç verisi bayrağı (v${CURRENT_INITIAL_DATA_VERSION}) ayarlandı.`);
                    placesListStatusElement.textContent = "Başlangıç verileri eklendi. Liste yükleniyor...";
                } else {
                    console.log(`[checkAndUpdateInitialData] Kullanıcı (${currentUserId}) için başlangıç verisi (v${CURRENT_INITIAL_DATA_VERSION}) zaten mevcut.`);
                }
            } catch (error) {
                console.error("[checkAndUpdateInitialData] Başlangıç verisi kontrol/ekleme hatası:", error);
                placesListStatusElement.textContent = "Başlangıç verileri hazırlanırken bir hata oluştu.";
            }
        }


        async function loadAndListenPlaces() {
            if (!placesCollectionRef) {
                console.error("[loadAndListenPlaces] placesCollectionRef tanımsız. Muhtemelen kullanıcı giriş yapmamış veya Firebase düzgün başlatılmamış.");
                placesListStatusElement.textContent = "Veritabanı bağlantısı kurulamadı (koleksiyon referansı yok). Lütfen giriş yapın.";
                return;
            }
            if (unsubscribePlaces) {
                console.log("[loadAndListenPlaces] Mevcut Firestore listener kaldırılıyor.");
                unsubscribePlaces();
                unsubscribePlaces = null;
            }
            console.log("[loadAndListenPlaces] Yeni onSnapshot listener'ı kuruluyor for", placesCollectionRef.path);
            placesListStatusElement.innerHTML = "Yer listesi Firestore'dan yükleniyor... <div class='loader !ml-0 !inline-block'></div>";

            // Firestore'da ülke ve isim alanlarına göre sıralama yapmak için birleşik indeks gerekebilir.
            // Eğer hata alırsanız (failed-precondition: The query requires an index...), Firebase konsolundan bu indeksi oluşturmanız gerekir.
            // İndeks: 'places' koleksiyonu, 'country' ASC, 'name' ASC
            const q = query(placesCollectionRef, orderBy("country"), orderBy("name"));

            unsubscribePlaces = onSnapshot(q, (snapshot) => {
                console.log(`[onSnapshot] ${snapshot.docs.length} döküman alındı.`);
                placesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                populateCountryFilter();
                renderPlacesList();
                updateGenerateRouteButtonState();

                if (currentUserId) {
                    if (placesData.length > 0) {
                        authStatusElement.textContent = `Yer listesi güncel (${placesData.length} yer).`;
                    } else {
                         // Eğer checkAndUpdateInitialData henüz bitmediyse bu mesaj görünebilir.
                        authStatusElement.textContent = "Liste dinleniyor...";
                        placesListStatusElement.textContent = "Listenizde henüz yer yok veya yükleniyor...";
                        if (initialPlacesData.length === 0 && !docSnap.exists()){ // Eğer başlangıç verisi yoksa ve ilk kez yükleniyorsa
                             placesListStatusElement.textContent = "Listenize yer eklemeye başlayabilirsiniz!";
                        }
                    }
                }
            }, (error) => {
                console.error("[onSnapshot] Firestore'dan yerleri dinleme hatası: ", error);
                authStatusElement.textContent = "Yer listesi yüklenemedi: " + error.message;
                placesListStatusElement.textContent = "Yer listesi yüklenirken bir hata oluştu.";
                 if (error.code === 'failed-precondition' && error.message.toLowerCase().includes('index')) {
                    authStatusElement.innerHTML += `<br><strong class="text-red-600">Firestore İndeks Hatası!</strong> Sıralama için gerekli birleşik indeks (country ASC, name ASC) bulunamadı. Lütfen Firebase konsolundan 'places' koleksiyonu için bu indeksi oluşturun.`;
                    placesListStatusElement.innerHTML = `<b>Önemli:</b> Verilerin doğru sıralanması için Firebase konsolunda bir indeks oluşturmanız gerekiyor. Hata mesajını kontrol edin.`;
                }
            });
        }

        function populateCountryFilter() {
            const currentSelectedCountry = countryFilterElement.value;
            countryFilterElement.innerHTML = '<option value="all">Tüm Ülkeler</option>';
            if (placesData && placesData.length > 0) {
                const countries = [...new Set(placesData.map(place => place.country).filter(Boolean))].sort();
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    countryFilterElement.appendChild(option);
                });
                if (countries.includes(currentSelectedCountry)) {
                    countryFilterElement.value = currentSelectedCountry;
                }
            }
        }

        function renderPlacesList() {
            placesListElement.scrollTop = 0;
            const visitedFilterValue = filterElement.value;
            const countryFilterValue = countryFilterElement.value;
            placesListElement.innerHTML = '';
            let currentCountryHeader = "";

            let tempFilteredPlaces = [...placesData];

            if (visitedFilterValue !== 'all') {
                tempFilteredPlaces = tempFilteredPlaces.filter(place => {
                    if (visitedFilterValue === 'visited') return place.visited;
                    if (visitedFilterValue === 'notvisited') return !place.visited;
                    return true; // 'all' ise filtreleme yapma
                });
            }

            if (countryFilterValue !== 'all') {
                tempFilteredPlaces = tempFilteredPlaces.filter(place => place.country === countryFilterValue);
            }

            if (tempFilteredPlaces.length === 0) {
                if (!currentUserId) {
                     placesListStatusElement.textContent = 'Yerleri görmek için lütfen giriş yapın.';
                } else if (placesData.length === 0 && initialPlacesData.length > 0) { // Henüz veri yüklenmemiş olabilir
                     placesListStatusElement.innerHTML = "Yer listesi Firestore'dan yükleniyor... <div class='loader !ml-0 !inline-block'></div>";
                }
                else {
                    placesListStatusElement.textContent = 'Bu filtreye uygun yer bulunamadı veya listeniz boş.';
                }
                placesListElement.innerHTML = `<p class="text-gray-500 italic p-4">${placesListStatusElement.textContent}</p>`;
                return;
            } else {
                 placesListStatusElement.innerHTML = '';
            }

            tempFilteredPlaces.forEach((place) => {
                if (!place || !place.id) {
                    console.warn("[renderPlacesList] Eksik 'id' veya tanımsız 'place' nesnesi atlanıyor:", place);
                    return;
                }
                if (place.country !== currentCountryHeader) {
                    currentCountryHeader = place.country || "Diğer";
                    const countryHeaderElement = document.createElement('h3');
                    countryHeaderElement.className = 'country-header';
                    countryHeaderElement.textContent = currentCountryHeader;
                    placesListElement.appendChild(countryHeaderElement);
                }

                const listItem = document.createElement('div');
                const isSelectedForRoute = selectedRouteOrder.find(p => p.id === place.id);
                listItem.className = `place-item p-4 border border-gray-200 rounded-lg shadow-sm cursor-pointer transition-all duration-150 ease-in-out mt-2 ${isSelectedForRoute ? 'selected-for-route' : ''}`;
                listItem.setAttribute('data-id', place.id);

                listItem.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-grow">
                            <h4 class="text-lg font-semibold text-sky-700">${place.name || 'İsimsiz Yer'}</h4>
                            <p class="text-sm text-gray-500">${place.city ? place.city + ', ' : ''}${place.country ? place.country.replace(' (BK)', '') : 'Bilinmeyen Ülke'}</p>
                            ${place.category ? `<span class="category-tag">${place.category}</span>` : '<span class="category-tag">Bilinmiyor</span>'}
                            <p class="text-sm text-gray-600 mt-1">${place.description || 'Açıklama bulunamadı.'}</p>
                            ${isSelectedForRoute ? `<p class="text-xs text-blue-600 font-semibold mt-1">Rota Sırası: ${isSelectedForRoute.order}</p>` : ''}
                        </div>
                        <div class="ml-4 flex-shrink-0 flex flex-col items-center space-y-2">
                            <div>
                                <input type="checkbox" id="visited-${place.id}" data-id="${place.id}" class="h-5 w-5 text-sky-600 border-gray-300 rounded focus:ring-sky-500" ${place.visited ? 'checked' : ''}>
                                <label for="visited-${place.id}" class="text-xs text-gray-500 ml-1">${place.visited ? 'Gezildi' : 'Gezilmedi'}</label>
                            </div>
                            <button class="delete-place-btn text-xs" data-id="${place.id}">Sil</button>
                        </div>
                    </div>
                `;
                placesListElement.appendChild(listItem);

                // Event listener for selecting/deselecting place for route
                listItem.addEventListener('click', async (event) => {
                    if (event.target.type === 'checkbox' || event.target.classList.contains('delete-place-btn')) {
                        return; // Checkbox veya silme butonu tıklamalarını yoksay
                    }
                    if (!currentUserId) {
                        alert("Rota oluşturmak için lütfen giriş yapın.");
                        return;
                    }

                    const placeId = place.id;
                    const existingPlaceIndex = selectedRouteOrder.findIndex(p => p.id === placeId);

                    if (existingPlaceIndex > -1) { // Eğer zaten seçiliyse, seçimden kaldır
                        selectedRouteOrder.splice(existingPlaceIndex, 1);
                        listItem.classList.remove('selected-for-route');
                        // Kalanların sıralamasını güncelle
                        selectedRouteOrder.forEach((p, index) => p.order = index + 1);
                    } else { // Yeni seçiliyorsa, sona ekle
                        selectedRouteOrder.push({ id: placeId, name: place.name, coordinates: place.coordinates, order: selectedRouteOrder.length + 1 });
                        listItem.classList.add('selected-for-route');
                    }
                    // Seçili yerlerin sırasını güncellemek için listeyi yeniden render et
                    renderPlacesList(); // Bu, sıralama numaralarını güncelleyecektir
                    updateGenerateRouteButtonState();
                    updateMap(place); // Haritada göster
                });

                // Event listener for visited checkbox
                const visitedCheckbox = listItem.querySelector(`#visited-${place.id}`);
                visitedCheckbox.addEventListener('change', async (event) => {
                    if (!currentUserId) {
                        alert("Değişiklik yapmak için lütfen giriş yapın.");
                        event.target.checked = !event.target.checked; // Değişikliği geri al
                        return;
                    }
                    const placeId = event.target.dataset.id;
                    const isVisited = event.target.checked;
                    try {
                        const placeDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/places`, placeId);
                        await updateDoc(placeDocRef, { visited: isVisited });
                        console.log(`Yer ${placeId} ziyaret durumu güncellendi: ${isVisited}`);
                        // Update local data to reflect change immediately, onSnapshot will also update it
                        const localPlace = placesData.find(p => p.id === placeId);
                        if (localPlace) localPlace.visited = isVisited;
                        // renderPlacesList(); // onSnapshot zaten tetikleyecek, ama anlık UI tepkisi için eklenebilir.
                    } catch (error) {
                        console.error("Ziyaret durumu güncellenirken hata:", error);
                        event.target.checked = !isVisited; // Hata durumunda değişikliği geri al
                    }
                });

                // Event listener for delete button
                const deleteButton = listItem.querySelector('.delete-place-btn');
                deleteButton.addEventListener('click', async () => {
                    if (!currentUserId) {
                        alert("Silme işlemi için lütfen giriş yapın.");
                        return;
                    }
                    const placeId = place.id; // closure'dan place.id'yi al
                    // Basit bir onaylama (custom modal daha iyi olurdu)
                    if (!confirm(`"${place.name}" adlı yeri silmek istediğinizden emin misiniz?`)) {
                        return;
                    }
                    try {
                        const placeDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/places`, placeId);
                        await deleteDoc(placeDocRef);
                        console.log(`Yer ${placeId} başarıyla silindi.`);
                        // Rota listesinden de kaldır (eğer varsa)
                        selectedRouteOrder = selectedRouteOrder.filter(p => p.id !== placeId);
                        selectedRouteOrder.forEach((p, index) => p.order = index + 1); // Sıralamayı güncelle
                        // renderPlacesList(); // onSnapshot zaten tetikleyecek
                        updateGenerateRouteButtonState();
                        routeLinkContainer.innerHTML = ''; // Silme sonrası rota linkini temizle
                    } catch (error) {
                        console.error("Yer silinirken hata:", error);
                        alert("Yer silinirken bir hata oluştu.");
                    }
                });
            });
        }

        function updateMap(place) {
            if (place && place.coordinates && place.coordinates.lat && place.coordinates.lng) {
                const lat = place.coordinates.lat;
                const lng = place.coordinates.lng;
                mapFrameElement.src = `https://maps.google.com/maps?q=${lat},${lng}&hl=tr&z=14&output=embed`;
                mapLocationNameElement.textContent = `${place.name} (${place.city || ''}, ${place.country || ''})`;
            } else if (place && place.name) { // Sadece isim varsa genel arama
                 mapFrameElement.src = `https://maps.google.com/maps?q=${encodeURIComponent(place.name + (place.city ? ', ' + place.city : '') + (place.country ? ', ' + place.country : ''))}&hl=tr&z=10&output=embed`;
                 mapLocationNameElement.textContent = `${place.name}`;
            }
             else {
                mapFrameElement.src = "https://maps.google.com/maps?output=embed&q=Avrupa"; // Varsayılan harita
                mapLocationNameElement.textContent = "";
            }
        }

        function updateGenerateRouteButtonState() {
            if (selectedRouteOrder.length > 1) { // En az 2 yer seçilmeli
                generateRouteBtn.disabled = false;
            } else {
                generateRouteBtn.disabled = true;
            }
        }

        generateRouteBtn.addEventListener('click', () => {
            if (selectedRouteOrder.length < 2) {
                alert("Rota oluşturmak için en az 2 yer seçmelisiniz.");
                return;
            }

            // Seçilen yerleri sıralarına göre ayarla
            const sortedPlacesForRoute = [...selectedRouteOrder].sort((a, b) => a.order - b.order);

            let googleMapsUrl = "https://www.google.com/maps/dir/";
            sortedPlacesForRoute.forEach(place => {
                if (place.coordinates && place.coordinates.lat && place.coordinates.lng) {
                    googleMapsUrl += `${place.coordinates.lat},${place.coordinates.lng}/`;
                } else {
                    googleMapsUrl += `${encodeURIComponent(place.name + (place.city ? ', ' + place.city : '') + (place.country ? ', ' + place.country : ''))}/`;
                }
            });

            routeLinkContainer.innerHTML = `
                <p class="text-green-600 font-semibold">Rota Oluşturuldu:</p>
                <a href="${googleMapsUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 underline break-all">${googleMapsUrl}</a>
            `;
            console.log("Oluşturulan Rota URL:", googleMapsUrl);
        });

        addPlaceBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                addPlaceMessage.textContent = "Yeni yer eklemek için lütfen giriş yapın.";
                addPlaceMessage.className = "text-sm mt-2 text-red-600";
                return;
            }
            const placeName = newPlaceNameInput.value.trim();
            if (!placeName) {
                addPlaceMessage.textContent = "Lütfen bir yer adı girin.";
                addPlaceMessage.className = "text-sm mt-2 text-red-600";
                return;
            }

            addPlaceBtnText.classList.add('hidden');
            addPlaceLoader.classList.remove('hidden');
            addPlaceBtn.disabled = true;
            addPlaceMessage.textContent = "";

            try {
                // Burada ideal olarak bir Geocoding API'si (Google Places API gibi) kullanarak
                // yer adı üzerinden koordinat, şehir, ülke gibi bilgileri çekmek gerekir.
                // Şimdilik manuel giriş veya basitleştirilmiş bir yapı varsayalım.
                // Örnek: Kullanıcıdan daha fazla bilgi isteyebilir veya sadece ismi kaydedebiliriz.

                // Bu örnekte, sadece ismi ve varsayılan bazı değerleri kaydediyoruz.
                // Gerçek bir uygulamada, bu kısmı bir API ile zenginleştirmelisiniz.
                const newPlace = {
                    name: placeName,
                    city: "", // API'den alınabilir
                    country: "", // API'den alınabilir
                    category: "Yeni Eklenen",
                    description: "Kullanıcı tarafından eklendi.",
                    visited: false,
                    coordinates: null, // API'den alınabilir { lat: ..., lng: ... }
                    createdAt: new Date().toISOString(),
                    userId: currentUserId
                };

                const docRef = await addDoc(placesCollectionRef, newPlace);
                console.log("Yeni yer eklendi, ID:", docRef.id);
                addPlaceMessage.textContent = `"${placeName}" başarıyla eklendi!`;
                addPlaceMessage.className = "text-sm mt-2 text-green-600";
                newPlaceNameInput.value = ""; // Giriş alanını temizle

                // API çağrısı simülasyonu için kısa bir bekleme (gerçek API çağrısı daha uzun sürebilir)
                // await new Promise(resolve => setTimeout(resolve, 1000));

            } catch (error) {
                console.error("Yeni yer eklenirken hata:", error);
                addPlaceMessage.textContent = "Yer eklenirken bir hata oluştu: " + error.message;
                addPlaceMessage.className = "text-sm mt-2 text-red-600";
            } finally {
                addPlaceBtnText.classList.remove('hidden');
                addPlaceLoader.classList.add('hidden');
                if (currentUserId) addPlaceBtn.disabled = false; // Sadece giriş yapılmışsa tekrar aktif et
            }
        });

        // Event listeners for filters
        filterElement.addEventListener('change', renderPlacesList);
        countryFilterElement.addEventListener('change', renderPlacesList);

        // Initialize Firebase on page load
        initializeFirebase();

        // Clean up Firestore listener on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribePlaces) {
                console.log("Sayfadan ayrılmadan önce Firestore listener kaldırılıyor.");
                unsubscribePlaces();
            }
        });

    </script>
</body>
</html>
