<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avrupa Gezi Listesi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .place-item:hover {
            background-color: #f0f9ff;
        }
        .place-item.selected-for-route {
            background-color: #dbeafe;
            border-left: 4px solid #2563eb;
        }
        .country-header {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e3a8a;
        }
        #generateRouteBtn, #addPlaceBtn, .delete-place-btn, #googleSignInBtn, #signOutBtn {
            transition: background-color 0.3s ease;
        }
        .category-tag {
            display: inline-block;
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-right: 0.25rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .delete-place-btn {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .delete-place-btn:hover {
            background-color: #fecaca; /* red-200 */
        }
        #userDisplay { 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
         .filter-container > div {
            margin-bottom: 0.5rem;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .filter-container {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .filter-container > div {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="container mx-auto max-w-7xl bg-white shadow-xl rounded-lg p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600">Avrupa Gezi Rotam</h1>
            <p class="text-gray-600 mt-2">Gezilecek yerleri işaretle, filtrele, sil ve haritada gör! Rota oluşturmak için yerlere tıklayarak seçin veya yeni yer ekleyin.</p>
            
            <div id="authContainer" class="mt-4">
                <button id="googleSignInBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center mx-auto">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.63 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path fill="none" d="M0 0h24v24H0z"/></svg>
                    Google ile Giriş Yap
                </button>
                <div id="userDisplay" class="hidden mt-2 justify-center">
                    <img id="userPhoto" class="w-8 h-8 rounded-full mr-2" alt="Kullanıcı Fotoğrafı">
                    <span id="userName" class="text-sm text-gray-700 font-medium"></span>
                    <button id="signOutBtn" class="ml-4 bg-red-500 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-xs shadow-md">Çıkış Yap</button>
                </div>
            </div>
            <p id="authStatus" class="text-xs text-gray-500 mt-1">Kimlik durumu: Kontrol ediliyor...</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-1"></p>
        </header>

        <div class="flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-3/5 lg:w-2/3 pr-0 md:pr-4">
                <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-slate-50">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Yeni Yer Ekle</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="newPlaceNameInput" placeholder="Örn: Etretat Kayalıkları" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                        <button id="addPlaceBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-md shadow-md flex items-center justify-center" disabled>
                            <span id="addPlaceBtnText">Yer Ekle</span>
                            <div id="addPlaceLoader" class="loader hidden"></div>
                        </button>
                    </div>
                    <div id="addPlaceMessage" class="text-sm mt-2"></div>
                </div>

                <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-700">Gezilecek Yerler</h2>
                        <p class="text-sm text-gray-500">Rota oluşturmak için listeden yerlere tıklayın.</p>
                    </div>
                     <div class="filter-container">
                        <div>
                            <label for="filterCountry" class="mr-2 text-gray-600">Ülke:</label>
                            <select id="filterCountry" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                <option value="all">Tüm Ülkeler</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterVisited" class="mr-2 text-gray-600">Ziyaret:</label>
                            <select id="filterVisited" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                <option value="all">Tümü</option>
                                <option value="notvisited" selected>Gezilmedi</option>
                                <option value="visited">Gezildi</option>
                            </select>
                        </div>
                    </div>
                </div>
                 <div class="mb-4">
                    <button id="generateRouteBtn" class="w-full sm:w-auto bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-md shadow-md disabled:opacity-50" disabled>
                        Seçilenlerle Rota Oluştur
                    </button>
                </div>
                <div id="routeLinkContainer" class="mb-4 text-sm"></div>
                <div id="placesList" class="space-y-1 max-h-[40vh] md:max-h-[50vh] overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-500 italic p-4">Lütfen Google ile giriş yapın veya yer listesinin yüklenmesini bekleyin...</p>
                </div>
            </div>

            <div class="w-full md:w-2/5 lg:w-1/3 mt-6 md:mt-0">
                <h2 id="mapTitle" class="text-2xl font-semibold text-gray-700 mb-2">Harita</h2>
                <p id="mapLocationName" class="text-sm text-gray-500 mb-4 h-5"></p>
                <div class="aspect-w-16 aspect-h-9 md:aspect-h-12 lg:aspect-h-10 rounded-lg overflow-hidden shadow-md">
                     <iframe id="mapFrame"
                        class="w-full h-full border-0"
                        loading="lazy"
                        allowfullscreen
                        referrerpolicy="no-referrer-when-downgrade"
                        src="https://maps.google.com/maps?q=Avrupa&t=&z=4&ie=UTF8&iwloc=&output=embed">
                    </iframe>
                </div>
                <p class="mt-4 text-xs text-gray-500">
                    Haritada bir yerin işaretlenmesi, o yerin genel konumunu gösterir. Rota oluşturma özelliği, seçilen yerleri Google Haritalar'a gönderir. Yeni yer ekleme özelliği, bilgileri otomatik olarak bulmaya çalışır; sonuçlar API'lerin yeteneklerine bağlıdır. Verileriniz Firebase'de saklanır.
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, updateDoc, onSnapshot, query, orderBy, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6bIJOkooeRSKWtb09zdNmMIjHDbXCzYA", 
            authDomain: "rotambenim.firebaseapp.com", 
            projectId: "rotambenim", 
            storageBucket: "rotambenim.firebasestorage.app", 
            messagingSenderId: "374285362920", 
            appId: "1:374285362920:web:b4058cf4a93e7337168b5d", 
            measurementId: "G-0QVZ4LDYPJ" 
        };
        
        const appId = firebaseConfig.appId || 'default-app-id';
        const CURRENT_INITIAL_DATA_VERSION = "1.1"; // Başlangıç verilerinizin güncel versiyonu
                                                // initialPlacesData'yı her değiştirdiğinizde bu versiyonu artırın (örn: "1.2")

        let app;
        let auth;
@ -213,18 +214,19 @@
        let unsubscribePlaces = null; 

        // Kapsamlı initialPlacesData dizisi (bir önceki yanıttaki gibi kapsamlı olmalı)
        // Örnek olarak kısa tutuyorum, kendi kapsamlı listenizi buraya eklemelisiniz.
        // Bu listeyi kendi kapsamlı listenizle değiştirin.
        const initialPlacesData = [
            // FRANSA
            { userGivenId: 'fr_001', country: "FRANSA", name: "Paris", city: "Paris", description: "Dünyanın en romantik şehirlerinden biri olan Paris, 'Işık Şehir' olarak da anılır. İkonik Eyfel Kulesi'nden şehrin panoramik manzarasını izleyebilir, Seine Nehri'nde tekne turu yapabilir ve dünyaca ünlü sanat eserlerine ev sahipliği yapan Louvre Müzesi'ni gezebilirsiniz. Şık bulvarları, tarihi kafeleri, bohem mahalleleri ve eşsiz Fransız mutfağıyla unutulmaz bir deneyim sunar.", category: "Başkent / İkonik / Kültürel / Sanat", visited: false, mapQuery: "Paris, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_002', country: "FRANSA", name: "Eyfel Kulesi", city: "Paris", description: "Paris'in ve Fransa'nın en tanınmış sembolü olan Eyfel Kulesi, Gustave Eiffel tarafından 1889 Evrensel Sergisi için tasarlanmıştır. Yılda milyonlarca ziyaretçi çeken bu demir kule, farklı katlarından şehrin muhteşem panoramik manzaralarını sunar. Gece ışıklandırmasıyla da büyüleyicidir.", category: "İkonik Yapı / Mimari / Manzara", visited: false, mapQuery: "Eyfel Kulesi, Paris", selectedForRoute: false },
            // İTALYA
            { userGivenId: 'it_001', country: "İTALYA", name: "Roma", city: "Roma", description: "Binlerce yıllık tarihiyle 'Ebedi Şehir' Roma, Kolezyum, Roma Forumu, Pantheon gibi antik dünyanın görkemli kalıntılarına ev sahipliği yapar. Vatikan Şehri (Aziz Petrus Bazilikası, Sistine Şapeli), Trevi Çeşmesi, İspanyol Merdivenleri gibi ikonik yapıları, sayısız müzesi, her köşede karşınıza çıkan sanat eserleri, lezzetli mutfağı (pizza, pasta, dondurma) ve canlı atmosferiyle adeta bir açık hava müzesidir. Trastevere gibi mahallelerinde kaybolmak keyiflidir.", category: "Başkent / Tarihi / Antik Kalıntı / Kültürel / Sanat / Gastronomi", visited: false, mapQuery: "Roma, İtalya", selectedForRoute: false },
             // İSPANYA (Örnek olarak İspanya'yı ekleyelim)
             // İSPANYA
            { userGivenId: 'es_001', country: "İSPANYA", name: "Barselona", city: "Barselona", description: "Katalonya'nın başkenti Barselona, Antoni Gaudí'nin eşsiz modernist mimarisinin damgasını vurduğu bir şehirdir. Yapımı hala devam eden La Sagrada Familia bazilikası, renkli mozaikleriyle Park Güell, hareketli La Rambla caddesi ve tarihi Gotik Mahallesi şehrin en önemli noktalarıdır. Akdeniz plajları ve canlı kültürel yaşamıyla da dikkat çeker.", category: "Şehir / Mimari / Kültürel / Sanat", visited: false, mapQuery: "Barselona, İspanya", selectedForRoute: false },
            { userGivenId: 'es_002', country: "İSPANYA", name: "El Hamra Sarayı", city: "Granada", description: "Endülüs Emevileri döneminden kalma bu muhteşem saray ve kale kompleksi, İslam mimarisinin en ince ve zarif örneklerinden birini sunar. Detaylı alçı oymaları, renkli çinileri, huzurlu avluları, serinletici çeşmeleri ve Generalife bahçeleriyle adeta bir masal diyarıdır. UNESCO Dünya Mirası listesindedir ve İspanya'nın en çok ziyaret edilen anıtlarındandır.", category: "Saray / Tarihi Yapı / İslam Mimarisi / UNESCO", visited: false, mapQuery: "El Hamra Sarayı, Granada", selectedForRoute: false },

            // ... (BURAYA DİĞER TÜM KAPSAMLI YER LİSTENİZİ EKLEYİN) ...
            // Örnek:
            // { userGivenId: 'de_001', country: "ALMANYA", name: "Neuschwanstein Şatosu", city: "Schwangau", description: "Bavyera Alpleri'nin eteklerinde, masalsı bir tepenin üzerine kurulmuş olan bu romantik şato...", category: "Şato / Mimari", visited: false, mapQuery: "Neuschwanstein Şatosu", selectedForRoute: false },
        ];
        let placesData = []; 

@ -320,8 +322,24 @@
            }
        }

        googleSignInBtn.addEventListener('click', async () => { /* Önceki gibi */ });
        signOutBtn.addEventListener('click', async () => { /* Önceki gibi */ });
        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google ile giriş hatası:", error);
                authStatusElement.textContent = "Google ile giriş yapılamadı: " + error.code + " - " + error.message;
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Çıkış yapma hatası:", error);
                authStatusElement.textContent = "Çıkış yapılamadı: " + error.message;
            }
        });
        
        async function checkAndUpdateInitialData() {
            if (!userId || !placesCollectionRef) return;
@ -331,12 +349,13 @@

            if (!initialPlacesData || initialPlacesData.length === 0) {
                console.log("Başlangıç verisi (initialPlacesData) boş veya tanımlanmamış. Seeding atlanıyor.");
                if (!versionSnap.exists()) { // DB'de de versiyon yoksa ve initialData boşsa, bayrağı yine de set et.
                if (!versionSnap.exists()) { 
                     await setDoc(dataVersionFlagDocRef, { version: CURRENT_INITIAL_DATA_VERSION, seededAt: new Date().toISOString(), count: 0 });
                }
                return;
            }
            
            // Eğer kod versiyonu DB versiyonundan farklıysa VEYA DB'de hiç versiyon yoksa, güncelle/ekle.
            if (currentDbVersion !== CURRENT_INITIAL_DATA_VERSION) {
                authStatusElement.innerHTML = `Başlangıç verileri güncelleniyor (Kod v${CURRENT_INITIAL_DATA_VERSION}, DB v${currentDbVersion || 'yok'})... Lütfen bekleyin. <div class='loader !ml-0 !inline-block'></div>`;
                const batch = writeBatch(db);
@ -348,19 +367,18 @@
                        continue;
                    }
                    const placeDocRef = doc(placesCollectionRef, place.userGivenId);
                    // Mevcut kullanıcı verilerini (visited, selectedForRoute) korumak için merge: true ile setDoc
                    // Ancak bu, initialPlacesData'daki bir yerin açıklaması değişirse,
                    // kullanıcının daha önce girdiği bir yerin üzerine yazacağı anlamına gelir.
                    // Daha iyi bir strateji, sadece belirli alanları güncellemektir.
                    // Şimdilik, initialPlacesData'daki tüm alanları yazıyoruz, bu da kullanıcının
                    // o userGivenId'ye sahip yer için yaptığı değişiklikleri (visited hariç) sıfırlayabilir.
                    // İdealde, sadece `description`, `category`, `city`, `mapQuery` güncellenmeli,
                    // `visited` ve `selectedForRoute` kullanıcı tarafından yönetilmeli.
                    // Bu basit versiyonda, tüm initialData'yı yazıyoruz.
                    const dataToSet = { ...place, id: placeDocRef.id };
                    // Eğer bu userGivenId ile Firestore'da bir döküman varsa ve seededVersion eski ise,
                    // kullanıcının 'visited' ve 'selectedForRoute' bilgilerini korumak isteyebiliriz.
                    // Bu örnekte basitçe üzerine yazıyoruz.
                    
                    // Mevcut dökümanı al (varsa)
                    const existingDocSnap = await getDoc(placeDocRef);
                    let dataToSet = { ...place, id: placeDocRef.id }; // Her zaman initialData'daki temel bilgileri al

                    if (existingDocSnap.exists()) {
                        // Eğer döküman varsa, kullanıcının değiştirebileceği alanları koru
                        const existingData = existingDocSnap.data();
                        dataToSet.visited = typeof existingData.visited === 'boolean' ? existingData.visited : place.visited;
                        dataToSet.selectedForRoute = typeof existingData.selectedForRoute === 'boolean' ? existingData.selectedForRoute : place.selectedForRoute;
                    }
                    // Diğer alanlar (description, category, city, mapQuery) her zaman initialPlacesData'dan güncellenir.
                    batch.set(placeDocRef, dataToSet); 
                    count++;
                }
@ -380,6 +398,7 @@
            }
        }


        async function loadAndListenPlaces() {
            if (!placesCollectionRef) return;
            if (unsubscribePlaces) unsubscribePlaces(); 
@ -394,27 +413,34 @@
                } else if(userId) { 
                     //authStatusElement.textContent = "Listenizde henüz yer yok. Yeni yer ekleyebilir veya başlangıç verilerinin yüklenmesini bekleyebilirsiniz.";
                }
            }, (error) => { /* ... (hata yönetimi önceki gibi) ... */ });

            }, (error) => { 
                console.error("Firestore'dan yerleri dinleme hatası: ", error);
                authStatusElement.textContent = "Yer listesi yüklenemedi: " + error.message;
                 if (error.code === 'failed-precondition' && error.message.includes('indexes-not-found')) {
                    authStatusElement.innerHTML += `<br><strong class="text-red-600">Firestore İndeks Hatası!</strong> Sıralama için gerekli birleşik indeks bulunamadı. Lütfen Firebase konsolundan oluşturun: <code class="bg-gray-200 p-1 rounded">${error.message.substring(error.message.indexOf('https://'), error.message.lastIndexOf('?'))}</code>`;
                }
            });
        }

        function renderPlacesList() { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ }
        function updateMap(place) { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ }
        function updateGenerateRouteButtonState() { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ }
        generateRouteBtn.addEventListener('click', () => { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ });
        addPlaceBtn.addEventListener('click', async () => { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ });

        filterElement.addEventListener('change', renderPlacesList); 
        countryFilterElement.addEventListener('change', renderPlacesList);
        
        initializeFirebase();

        window.addEventListener('beforeunload', () => {
            if (unsubscribePlaces) {
                unsubscribePlaces();
            }
        });

    </script>
</body>
</html>
