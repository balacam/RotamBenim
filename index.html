<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avrupa Gezi Listesi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .place-item:hover {
            background-color: #f0f9ff;
        }
        .place-item.selected-for-route {
            background-color: #dbeafe;
            border-left: 4px solid #2563eb;
        }
        .country-header {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e3a8a;
        }
        #generateRouteBtn, #addPlaceBtn, .delete-place-btn, #googleSignInBtn, #signOutBtn {
            transition: background-color 0.3s ease;
        }
        .category-tag {
            display: inline-block;
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-right: 0.25rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .delete-place-btn {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .delete-place-btn:hover {
            background-color: #fecaca; /* red-200 */
        }
        #userDisplay { /* HTML'de justify-center eklendi, buradan kaldırılabilir veya özelleştirilebilir */
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
         .filter-container > div {
            margin-bottom: 0.5rem;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .filter-container {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .filter-container > div {
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div class="container mx-auto max-w-7xl bg-white shadow-xl rounded-lg p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-600">Avrupa Gezi Rotam</h1>
            <p class="text-gray-600 mt-2">Gezilecek yerleri işaretle, filtrele, sil ve haritada gör! Rota oluşturmak için yerlere tıklayarak seçin veya yeni yer ekleyin.</p>
            
            <div id="authContainer" class="mt-4">
                <button id="googleSignInBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center mx-auto">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.63 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path fill="none" d="M0 0h24v24H0z"/></svg>
                    Google ile Giriş Yap
                </button>
                <div id="userDisplay" class="hidden mt-2 justify-center">
                    <img id="userPhoto" class="w-8 h-8 rounded-full mr-2" alt="Kullanıcı Fotoğrafı">
                    <span id="userName" class="text-sm text-gray-700 font-medium"></span>
                    <button id="signOutBtn" class="ml-4 bg-red-500 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md text-xs shadow-md">Çıkış Yap</button>
                </div>
            </div>
            <p id="authStatus" class="text-xs text-gray-500 mt-1">Kimlik durumu: Kontrol ediliyor...</p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-1"></p>
        </header>

        <div class="flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-3/5 lg:w-2/3 pr-0 md:pr-4">
                <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-slate-50">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Yeni Yer Ekle</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="newPlaceNameInput" placeholder="Örn: Etretat Kayalıkları" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                        <button id="addPlaceBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-md shadow-md flex items-center justify-center" disabled>
                            <span id="addPlaceBtnText">Yer Ekle</span>
                            <div id="addPlaceLoader" class="loader hidden"></div>
                        </button>
                    </div>
                    <div id="addPlaceMessage" class="text-sm mt-2"></div>
                </div>

                <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-700">Gezilecek Yerler</h2>
                        <p class="text-sm text-gray-500">Rota oluşturmak için listeden yerlere tıklayın.</p>
                    </div>
                     <div class="filter-container">
                        <div>
                            <label for="filterCountry" class="mr-2 text-gray-600">Ülke:</label>
                            <select id="filterCountry" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                <option value="all">Tüm Ülkeler</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterVisited" class="mr-2 text-gray-600">Ziyaret:</label>
                            <select id="filterVisited" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                                <option value="all">Tümü</option>
                                <option value="notvisited" selected>Gezilmedi</option>
                                <option value="visited">Gezildi</option>
                            </select>
                        </div>
                    </div>
                </div>
                 <div class="mb-4">
                    <button id="generateRouteBtn" class="w-full sm:w-auto bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-md shadow-md disabled:opacity-50" disabled>
                        Seçilenlerle Rota Oluştur
                    </button>
                </div>
                <div id="routeLinkContainer" class="mb-4 text-sm"></div>
                <div id="placesList" class="space-y-1 max-h-[40vh] md:max-h-[50vh] overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-500 italic p-4">Lütfen Google ile giriş yapın veya yer listesinin yüklenmesini bekleyin...</p>
                </div>
            </div>

            <div class="w-full md:w-2/5 lg:w-1/3 mt-6 md:mt-0">
                <h2 id="mapTitle" class="text-2xl font-semibold text-gray-700 mb-2">Harita</h2>
                <p id="mapLocationName" class="text-sm text-gray-500 mb-4 h-5"></p>
                <div class="aspect-w-16 aspect-h-9 md:aspect-h-12 lg:aspect-h-10 rounded-lg overflow-hidden shadow-md">
                     <iframe id="mapFrame"
                        class="w-full h-full border-0"
                        loading="lazy"
                        allowfullscreen
                        referrerpolicy="no-referrer-when-downgrade"
                        src="https://maps.google.com/maps?q=Avrupa&t=&z=4&ie=UTF8&iwloc=&output=embed">
                    </iframe>
                </div>
                <p class="mt-4 text-xs text-gray-500">
                    Haritada bir yerin işaretlenmesi, o yerin genel konumunu gösterir. Rota oluşturma özelliği, seçilen yerleri Google Haritalar'a gönderir. Yeni yer ekleme özelliği, bilgileri otomatik olarak bulmaya çalışır; sonuçlar API'lerin yeteneklerine bağlıdır. Verileriniz Firebase'de saklanır.
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, updateDoc, onSnapshot, query, orderBy, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6bIJOkooeRSKWtb09zdNmMIjHDbXCzYA", 
            authDomain: "rotambenim.firebaseapp.com", 
            projectId: "rotambenim", 
            storageBucket: "rotambenim.firebasestorage.app", 
            messagingSenderId: "374285362920", 
            appId: "1:374285362920:web:b4058cf4a93e7337168b5d", 
            measurementId: "G-0QVZ4LDYPJ" 
        };
        
        const appId = firebaseConfig.appId || 'default-app-id';

        let app;
        let auth;
        let db;
        let userId;
        let placesCollectionRef; 
        let unsubscribePlaces = null; 

        // initialPlacesData'yı bir önceki kapsamlı halinden alın veya aşağıdaki gibi kısa tutun
        // ve kullanıcının tarayıcı verilerini temizleyerek seeding'i tetiklemesini sağlayın.
        const initialPlacesData = [
            // FRANSA
            { userGivenId: 'fr_001', country: "FRANSA", name: "Paris", city: "Paris", description: "Dünyanın en romantik şehirlerinden biri olan Paris, 'Işık Şehir' olarak da anılır. İkonik Eyfel Kulesi'nden şehrin panoramik manzarasını izleyebilir, Seine Nehri'nde tekne turu yapabilir ve dünyaca ünlü sanat eserlerine ev sahipliği yapan Louvre Müzesi'ni gezebilirsiniz. Şık bulvarları, tarihi kafeleri, bohem mahalleleri ve eşsiz Fransız mutfağıyla unutulmaz bir deneyim sunar.", category: "Başkent / İkonik / Kültürel / Sanat", visited: false, mapQuery: "Paris, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_002', country: "FRANSA", name: "Eyfel Kulesi", city: "Paris", description: "Paris'in ve Fransa'nın en tanınmış sembolü olan Eyfel Kulesi, Gustave Eiffel tarafından 1889 Evrensel Sergisi için tasarlanmıştır. Yılda milyonlarca ziyaretçi çeken bu demir kule, farklı katlarından şehrin muhteşem panoramik manzaralarını sunar. Gece ışıklandırmasıyla da büyüleyicidir.", category: "İkonik Yapı / Mimari / Manzara", visited: false, mapQuery: "Eyfel Kulesi, Paris", selectedForRoute: false },
            { userGivenId: 'fr_003', country: "FRANSA", name: "Louvre Müzesi", city: "Paris", description: "Dünyanın en büyük ve en çok ziyaret edilen sanat müzesi olan Louvre, Mona Lisa, Venus de Milo ve Kanatlı Zafer gibi paha biçilemez başyapıtlara ev sahipliği yapar. Eski bir kraliyet sarayı olan yapı, cam piramidiyle ünlü girişinden geçerek binlerce yıllık sanat ve medeniyet tarihine bir yolculuk sunar.", category: "Müze / Sanat / Tarih / Kültürel Miras", visited: false, mapQuery: "Louvre Müzesi, Paris", selectedForRoute: false },
            { userGivenId: 'fr_004', country: "FRANSA", name: "Mont Saint-Michel", city: "", description: "Normandiya kıyılarında, gelgit sularıyla çevrili kayalık bir ada üzerinde yükselen bu görkemli Orta Çağ manastırı ve köyü, masalsı bir görünüme sahiptir. Dar sokakları, tarihi yapıları ve tepesinden sunduğu muhteşem manzaralarla UNESCO Dünya Mirası listesindedir. Özellikle suların yükseldiği zamanlarda adanın karayla bağlantısının kesilmesi etkileyicidir.", category: "Tarihi Yapı / Manastır / UNESCO / Ada", visited: false, mapQuery: "Mont Saint-Michel, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_005', country: "FRANSA", name: "Versailles Sarayı", city: "Versailles", description: "Fransız monarşisinin gücünü ve ihtişamını simgeleyen bu devasa saray, Barok mimarinin en görkemli örneklerindendir. Ünlü Aynalar Salonu, kraliyet daireleri, opera binası ve André Le Nôtre tarafından tasarlanan uçsuz bucaksız, geometrik düzenli bahçeleriyle ziyaretçilerini büyüler. Bahçelerindeki çeşmeler, heykeller ve Büyük Kanal başlı başına bir sanat eseridir.", category: "Saray / Tarihi Yapı / Bahçe / UNESCO / Barok", visited: false, mapQuery: "Versailles Sarayı", selectedForRoute: false },
            { userGivenId: 'fr_006', country: "FRANSA", name: "Nice", city: "Nice", description: "Fransız Rivierası'nın (Cote d'Azur) kalbi olan Nice, Akdeniz'in masmavi suları, palmiyelerle süslü Promenade des Anglais kordonu, renkli eski şehri (Vieux Nice) ve canlı çiçek pazarıyla (Cours Saleya) ünlüdür. Matisse ve Chagall gibi sanatçıların eserlerini barındıran müzeleri, canlı pazarları ve Akdeniz mutfağıyla keyifli bir tatil vaat eder.", category: "Şehir / Tatil / Kıyı / Sanat / Pazar", visited: false, mapQuery: "Nice, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_007', country: "FRANSA", name: "Cannes", city: "Cannes", description: "Dünyaca ünlü film festivaline ev sahipliği yapan Cannes, lüks otelleri, şık butikleri, yat limanı ve kumlu plajlarıyla Fransız Rivierası'nın gözde destinasyonlarındandır. La Croisette bulvarında yürüyüş yapmak, yıldızların izlerini takip etmek ve Lérins Adaları'na (Île Sainte-Marguerite ve Île Saint-Honorat) günübirlik bir gezi yapmak popüler aktivitelerdendir.", category: "Şehir / Etkinlik / Lüks / Tatil / Kıyı", visited: false, mapQuery: "Cannes, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_008', country: "FRANSA", name: "Colmar (Alsace)", city: "Colmar", description: "Alsace şarap yolu üzerinde yer alan Colmar, 'Küçük Venedik' (Petite Venise) olarak bilinen kanalları, rengarenk yarı ahşap evleri (colombages) ve çiçeklerle bezeli sokaklarıyla adeta bir masal diyarıdır. Sakin atmosferi, yerel lezzetleri (özellikle Tarte Flambée ve Choucroute) ve Alsace şaraplarıyla huzurlu bir kaçış noktasıdır. Noel pazarları da oldukça ünlüdür.", category: "Şehir / Kültürel / Şirin Kasaba / Gastronomi / Şarap", visited: false, mapQuery: "Colmar, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_009', country: "FRANSA", name: "Strasbourg Katedrali", city: "Strasbourg", description: "Notre-Dame de Strasbourg olarak da bilinen bu katedral, Gotik mimarinin en etkileyici ve zarif örneklerinden biridir. Pembe kumtaşından yapılmış dış cephesi, devasa astronomik saati (her gün saat 12:30'da figürleri hareket eder), büyüleyici vitrayları ve 142 metrelik kulesiyle ziyaretçilerini hayran bırakır. Kulesinden şehrin ve Ren Nehri'nin panoramik manzarasını seyretmek mümkündür.", category: "Dini Yapı / Mimari / Tarihi / Gotik / UNESCO", visited: false, mapQuery: "Strasbourg Katedrali", selectedForRoute: false },
            { userGivenId: 'fr_010', country: "FRANSA", name: "Cote d'Azur (Fransız Rivierası)", city: "", description: "Akdeniz kıyı şeridinin bu efsanevi bölümü, Nice, Cannes, Antibes, Monaco ve Saint-Tropez gibi dünyaca ünlü tatil beldelerine ev sahipliği yapar. Göz alıcı plajları, turkuaz suları, lüks yatları, hareketli gece hayatı, parfüm endüstrisinin merkezi Grasse ve Eze gibi tepedeki kartal yuvası köyleriyle bilinir. Sanatçılara ilham veren ışığı ve manzaralarıyla ünlüdür.", category: "Kıyı Şeridi / Tatil / Lüks / Manzara / Kültürel", visited: false, mapQuery: "French Riviera", selectedForRoute: false },
            { userGivenId: 'fr_011', country: "FRANSA", name: "Dordogne Bölgesi", city: "", description: "Güneybatı Fransa'da yer alan bu bölge, tarih öncesi çağlardan kalma mağara resimleri (Lascaux gibi UNESCO mirası), yüzlerce Orta Çağ şatosu (Castelnaud, Beynac, Les Milandes), pitoresk nehir kenarı köyleri (La Roque-Gageac, Domme) ve zengin yerel mutfağı (trüf mantarı, kaz ciğeri, ceviz, ördek konfi) ile ünlüdür. Dordogne Nehri'nde kano yapmak ve bölgenin yemyeşil doğasında yürüyüşler yapmak popülerdir.", category: "Bölge / Tarihi / Doğa / Gastronomi / Şato / Mağara", visited: false, mapQuery: "Dordogne, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_012', country: "FRANSA", name: "Chamonix ve Mont Blanc", city: "Chamonix", description: "Avrupa'nın en yüksek zirvesi olan Mont Blanc'ın (4,808 m) eteklerinde yer alan Chamonix, dünyaca ünlü bir dağcılık, tırmanış, kayak, snowboard ve kış sporları merkezidir. Aiguille du Midi teleferiği ile 3,842 metreye çıkarak Mont Blanc'a ve çevresindeki Alp zirvelerine nefes kesen manzaralar eşliğinde bakabilir, Mer de Glace buzuluna trenle ulaşabilirsiniz.", category: "Doğa / Spor / Dağ / Manzara / Kayak", visited: false, mapQuery: "Chamonix Mont Blanc", selectedForRoute: false },
            { userGivenId: 'fr_013', country: "FRANSA", name: "Étretat Kayalıkları", city: "Étretat", description: "Normandiya'nın Alabaster Sahili'nde yer alan bu beyaz tebeşir kayalıkları, özellikle 'Fil Hortumu' (Porte d'Aval), 'İğne' (Aiguille) ve Manneporte gibi doğal kemer ve kaya oluşumlarıyla ünlüdür. Manzaraları, Claude Monet ve Gustave Courbet gibi birçok empresyonist ressama ilham vermiştir. Kıyı boyunca uzanan yürüyüş parkurları muhteşem fotoğraf fırsatları sunar.", category: "Doğal Güzellik / Kıyı / Manzara / Jeolojik / Yürüyüş", visited: false, mapQuery: "Étretat, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_014', country: "FRANSA", name: "Provence", city: "", description: "Güney Fransa'nın bu büyüleyici bölgesi, yaz aylarında mora bürünen uçsuz bucaksız lavanta tarlaları (Valensole Platosu gibi), altın sarısı ayçiçeği tarlaları, zeytinlikleri, tarihi Roma kalıntıları (Pont du Gard, Nimes Arenası, Orange Antik Tiyatrosu), Gordes ve Roussillon gibi şirin tepe köyleri ve lezzetli Akdeniz mutfağı ile ünlüdür. Sanatçılara (Van Gogh, Cézanne) ilham veren ışığı ve renkleriyle bilinir.", category: "Bölge / Kültürel / Doğa / Gastronomi / Kırsal / Tarihi", visited: false, mapQuery: "Provence, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_015', country: "FRANSA", name: "Loire Vadisi", city: "", description: "Fransa'nın 'Bahçesi' olarak da bilinen Loire Vadisi, görkemli şatoları (Chambord, Chenonceau, Amboise, Villandry, Cheverny gibi 300'den fazla), verimli üzüm bağları (Sancerre, Pouilly-Fumé şarapları), tarihi kasabaları (Tours, Blois, Orléans) ve Loire Nehri boyunca uzanan pitoresk manzaralarıyla UNESCO Dünya Mirası listesindedir. Bisiklet turları ve şarap tadımı için popüler bir destinasyondur.", category: "Bölge / Şato / Kültürel / Şarap / UNESCO / Bisiklet", visited: false, mapQuery: "Loire Valley, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_016', country: "FRANSA", name: "Korsika", city: "Korsika", description: "Akdeniz'in 'Güzellik Adası' (Île de Beauté) olarak anılan Korsika, sarp dağları, sık ormanları, el değmemiş kumsalları (Palombaggia, Santa Giulia), berrak suları ve Bonifacio gibi etkileyici falez kasabalarıyla hem doğa severler hem de macera arayanlar için idealdir. GR20 gibi Avrupa'nın en zorlu ve güzel yürüyüş rotalarından birine ev sahipliği yapar. Kendine özgü kültürü ve mutfağı da dikkat çekicidir.", category: "Ada / Doğa / Macera / Plaj / Yürüyüş / Kültürel", visited: false, mapQuery: "Korsika, Fransa", selectedForRoute: false },
            { userGivenId: 'fr_017', country: "FRANSA", name: "Verdon Kanyonu", city: "", description: "'Avrupa'nın Büyük Kanyonu' olarak da bilinen bu etkileyici nehir kanyonu, Provence bölgesinde yer alır. Turkuaz renkli Verdon Nehri'nin milyonlarca yılda oyduğu kireçtaşı vadileri, 700 metreye varan derinliğiyle nefes keser. Kano, kayak, rafting, kaya tırmanışı ve kanyon boyunca uzanan manzaralı yollarda (Route des Crêtes) sürüş yapmak popüler aktivitelerdir. Lac de Sainte-Croix gölü de kanyonun girişinde yer alır.", category: "Doğa / Kanyon / Macera Sporları / Manzara / Göl", visited: false, mapQuery: "Verdon Gorge, Fransa", selectedForRoute: false },
            
        
        ];
        let placesData = []; 

        const placesListElement = document.getElementById('placesList');
        const filterElement = document.getElementById('filterVisited');
        const countryFilterElement = document.getElementById('filterCountry');
        const mapFrameElement = document.getElementById('mapFrame');
        const mapLocationNameElement = document.getElementById('mapLocationName');
        const generateRouteBtn = document.getElementById('generateRouteBtn');
        const routeLinkContainer = document.getElementById('routeLinkContainer');
        const newPlaceNameInput = document.getElementById('newPlaceNameInput');
        const addPlaceBtn = document.getElementById('addPlaceBtn');
        const addPlaceBtnText = document.getElementById('addPlaceBtnText');
        const addPlaceLoader = document.getElementById('addPlaceLoader');
        const addPlaceMessage = document.getElementById('addPlaceMessage');
        
        const authContainer = document.getElementById('authContainer');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const userDisplay = document.getElementById('userDisplay');
        const userNameElement = document.getElementById('userName');
        const userPhotoElement = document.getElementById('userPhoto'); // Kullanıcı fotoğrafı için
        const signOutBtn = document.getElementById('signOutBtn');
        const authStatusElement = document.getElementById('authStatus');
        const userIdDisplayElement = document.getElementById('userIdDisplay');

        let selectedRouteOrder = []; 

        function populateCountryFilter() {
            // Firestore'dan gelen güncel placesData'yı kullanarak ülke filtresini doldur
            countryFilterElement.innerHTML = '<option value="all">Tüm Ülkeler</option>'; 
            if (placesData && placesData.length > 0) {
                const countries = [...new Set(placesData.map(place => place.country).filter(Boolean))].sort();
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    countryFilterElement.appendChild(option);
                });
            }
        }

        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                authStatusElement.textContent = "Firebase yapılandırması eksik veya hatalı.";
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                authStatusElement.textContent = "Firebase başlatıldı. Kimlik durumu bekleniyor...";
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) { 
                        userId = user.uid;
                        userNameElement.textContent = user.displayName || user.email || "Kullanıcı";
                        if(user.photoURL) {
                            userPhotoElement.src = user.photoURL;
                            userPhotoElement.classList.remove('hidden');
                        } else {
                            userPhotoElement.classList.add('hidden');
                        }
                        authStatusElement.textContent = `Hoşgeldiniz, ${userNameElement.textContent}!`;
                        userIdDisplayElement.textContent = `Kullanıcı ID: ${userId.substring(0,12)}...`; 
                        
                        googleSignInBtn.classList.add('hidden');
                        userDisplay.classList.remove('hidden');
                        userDisplay.classList.add('flex'); // ensure it's flex for alignment
                        addPlaceBtn.disabled = false; 

                        placesCollectionRef = collection(db, `users/${userId}/europeTravelPlaces`);
                        loadAndListenPlaces();
                    } else { 
                        userId = null;
                        userNameElement.textContent = '';
                        userPhotoElement.classList.add('hidden');
                        authStatusElement.textContent = "Lütfen Google ile giriş yapın.";
                        userIdDisplayElement.textContent = '';
                        
                        googleSignInBtn.classList.remove('hidden');
                        userDisplay.classList.add('hidden');
                        userDisplay.classList.remove('flex');
                        addPlaceBtn.disabled = true; 
                        placesData = []; 
                        renderPlacesList(); 
                        if (unsubscribePlaces) unsubscribePlaces(); 
                        populateCountryFilter(); // Boş veya sadece "Tüm Ülkeler" ile doldur
                    }
                });
            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                authStatusElement.textContent = "Firebase başlatılamadı: " + error.message;
            }
        }

        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google ile giriş hatası:", error);
                authStatusElement.textContent = "Google ile giriş yapılamadı: " + error.code + " - " + error.message;
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Çıkış yapma hatası:", error);
                authStatusElement.textContent = "Çıkış yapılamadı: " + error.message;
            }
        });
        
        async function loadAndListenPlaces() {
            if (!placesCollectionRef) return;
            authStatusElement.innerHTML = "Yer listesi Firestore'dan yükleniyor... <div class='loader !ml-0 !inline-block'></div>"; // Yükleme göstergesi
            if (unsubscribePlaces) unsubscribePlaces(); 

            const initialSeedFlagDocRef = doc(db, `users/${userId}/europeTravelFlags`, "initialSeedDone_v7_google"); 
            const seedFlagSnap = await getDoc(initialSeedFlagDocRef);

            if (!seedFlagSnap.exists() && initialPlacesData.length > 0) {
                authStatusElement.innerHTML = `İlk veriler (${initialPlacesData.length} adet) Firestore'a ekleniyor... Lütfen bekleyin. <div class='loader !ml-0 !inline-block'></div>`;
                const batch = writeBatch(db);
                let count = 0;
                initialPlacesData.forEach(place => {
                    const placeDocRef = doc(placesCollectionRef, place.userGivenId);
                    batch.set(placeDocRef, { ...place, id: placeDocRef.id });
                    count++;
                });
                try {
                    await batch.commit();
                    await setDoc(initialSeedFlagDocRef, { seeded: true, seededAt: new Date().toISOString(), count: count, version: "7.0_google" });
                    authStatusElement.textContent = `${count} başlangıç yeri eklendi. Liste dinleniyor...`;
                } catch (e) {
                     console.error("İlk veri ekleme (batch) hatası:", e);
                     authStatusElement.textContent = "İlk veri eklemede hata. Lütfen konsolu kontrol edin.";
                }
            } else if (seedFlagSnap.exists()) {
                 authStatusElement.textContent = `Başlangıç verileri daha önce eklenmiş. Liste dinleniyor...`;
            } else {
                authStatusElement.textContent = "Başlangıç verisi yok veya zaten eklenmiş. Liste dinleniyor...";
            }

            unsubscribePlaces = onSnapshot(query(placesCollectionRef, orderBy("country"), orderBy("name")), (snapshot) => {
                placesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCountryFilter(); // Veri güncellendiğinde ülke filtresini de güncelle
                renderPlacesList();
                updateGenerateRouteButtonState();
                 if (placesData.length > 0) {
                    authStatusElement.textContent = `Yer listesi güncel (${placesData.length} yer).`;
                } else if(userId) { // Kullanıcı giriş yapmış ama veri yoksa
                     authStatusElement.textContent = "Listenizde henüz yer yok. Yeni yer ekleyebilir veya başlangıç verilerinin yüklenmesini bekleyebilirsiniz.";
                }

            }, (error) => { 
                console.error("Firestore'dan yerleri dinleme hatası: ", error);
                authStatusElement.textContent = "Yer listesi yüklenemedi: " + error.message;
                 if (error.code === 'failed-precondition' && error.message.includes('indexes-not-found')) {
                    authStatusElement.innerHTML += `<br><strong class="text-red-600">Firestore İndeks Hatası!</strong> Sıralama için gerekli birleşik indeks bulunamadı. Lütfen Firebase konsolundan oluşturun: <code class="bg-gray-200 p-1 rounded">${error.message.substring(error.message.indexOf('https://'), error.message.lastIndexOf('?'))}</code>`;
                }
            });
        }

        function renderPlacesList() {
            const visitedFilterValue = filterElement.value;
            const countryFilterValue = countryFilterElement.value;
            placesListElement.innerHTML = ''; 
            let currentCountryHeader = ""; 

            let tempFilteredPlaces = placesData;

            if (visitedFilterValue !== 'all') {
                tempFilteredPlaces = tempFilteredPlaces.filter(place => {
                    if (visitedFilterValue === 'visited') return place.visited;
                    if (visitedFilterValue === 'notvisited') return !place.visited;
                    return true;
                });
            }

            if (countryFilterValue !== 'all') {
                tempFilteredPlaces = tempFilteredPlaces.filter(place => place.country === countryFilterValue);
            }
            
            if (tempFilteredPlaces.length === 0) {
                placesListElement.innerHTML = '<p class="text-gray-500 italic p-4">Bu filtreye uygun yer bulunamadı veya liste boş.</p>';
                return;
            }
            
            tempFilteredPlaces.forEach(place => {
                if (place.country !== currentCountryHeader) {
                    currentCountryHeader = place.country || "Diğer";
                    const countryHeaderElement = document.createElement('h3');
                    countryHeaderElement.className = 'country-header';
                    countryHeaderElement.textContent = currentCountryHeader;
                    placesListElement.appendChild(countryHeaderElement);
                }

                const listItem = document.createElement('div');
                listItem.className = `place-item p-4 border border-gray-200 rounded-lg shadow-sm cursor-pointer transition-all duration-150 ease-in-out mt-2 ${place.selectedForRoute ? 'selected-for-route' : ''}`;
                listItem.setAttribute('data-id', place.id); 
                
                listItem.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-grow">
                            <h4 class="text-lg font-semibold text-sky-700">${place.name}</h4>
                            <p class="text-sm text-gray-500">${place.city ? place.city + ', ' : ''}${place.country ? place.country.replace(' (BK)', '') : 'Bilinmeyen Ülke'}</p>
                            ${place.category ? `<span class="category-tag">${place.category}</span>` : '<span class="category-tag">Bilinmiyor</span>'}
                            <p class="text-sm text-gray-600 mt-1">${place.description || 'Açıklama bulunamadı.'}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex flex-col items-center space-y-2">
                            <div>
                                <input type="checkbox" id="visited-${place.id}" data-id="${place.id}" class="h-5 w-5 text-sky-600 border-gray-300 rounded focus:ring-sky-500" ${place.visited ? 'checked' : ''}>
                                <label for="visited-${place.id}" class="text-xs text-gray-500 ml-1">${place.visited ? 'Gezildi' : 'Gezilmedi'}</label>
                            </div>
                            <button class="delete-place-btn" data-id="${place.id}">Sil</button>
                        </div>
                    </div>
                `;

                listItem.addEventListener('click', async (event) => {
                    if (event.target.classList.contains('delete-place-btn') || event.target.id.startsWith('visited-') || (event.target.tagName === 'LABEL' && event.target.htmlFor.startsWith('visited-'))) {
                        return;
                    }
                    const placeId = place.id;
                    const targetPlaceInLocalData = placesData.find(p => p.id === placeId); 
                    if (targetPlaceInLocalData) {
                        const newSelectedState = !targetPlaceInLocalData.selectedForRoute;
                         if (placesCollectionRef) { 
                            const placeDocRef = doc(db, `users/${userId}/europeTravelPlaces`, placeId);
                            try {
                                await updateDoc(placeDocRef, { selectedForRoute: newSelectedState });
                                if (newSelectedState) {
                                    if (!selectedRouteOrder.includes(targetPlaceInLocalData.id)) selectedRouteOrder.push(targetPlaceInLocalData.id);
                                } else {
                                    selectedRouteOrder = selectedRouteOrder.filter(id => id !== targetPlaceInLocalData.id);
                                }
                                updateMap(targetPlaceInLocalData); 
                                updateGenerateRouteButtonState();
                            } catch (e) { console.error("Rota seçimi güncelleme hatası:", e); }
                        }
                    }
                });

                const visitedCheckbox = listItem.querySelector(`#visited-${place.id}`);
                visitedCheckbox.addEventListener('change', async (event) => {
                    const placeId = event.target.dataset.id;
                    const isChecked = event.target.checked;
                    if (placesCollectionRef) {
                        const placeDocRef = doc(db, `users/${userId}/europeTravelPlaces`, placeId);
                        try {
                            await updateDoc(placeDocRef, { visited: isChecked });
                        } catch (e) { console.error("Ziyaret durumu güncelleme hatası:", e); }
                    }
                });

                const deleteButton = listItem.querySelector('.delete-place-btn');
                deleteButton.addEventListener('click', async () => {
                    const placeIdToDelete = deleteButton.dataset.id;
                    const placeNameToDelete = placesData.find(p => p.id === placeIdToDelete)?.name || "bu yer";
                     if (confirm(`'${placeNameToDelete}' adlı yeri silmek istediğinizden emin misiniz?`)) {
                        if (placesCollectionRef) {
                            const placeDocRef = doc(db, `users/${userId}/europeTravelPlaces`, placeIdToDelete);
                            try {
                                await deleteDoc(placeDocRef);
                                selectedRouteOrder = selectedRouteOrder.filter(id => id !== placeIdToDelete);
                            } catch (e) { console.error("Yer silme hatası:", e); }
                        }
                    }
                });
                placesListElement.appendChild(listItem);
            });
        }

        function updateMap(place) { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ }
        function updateGenerateRouteButtonState() { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ }
        generateRouteBtn.addEventListener('click', () => { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ });
        addPlaceBtn.addEventListener('click', async () => { /* ... (Bu fonksiyonun içeriği öncekiyle aynı) ... */ });

        filterElement.addEventListener('change', renderPlacesList); 
        countryFilterElement.addEventListener('change', renderPlacesList);
        
        initializeFirebase();

        window.addEventListener('beforeunload', () => {
            if (unsubscribePlaces) {
                unsubscribePlaces();
            }
        });

    </script>
</body>
</html>

